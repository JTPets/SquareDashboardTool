# Deep Codebase Audit — Post-Remediation

**Date**: 2026-02-28
**Auditor**: Automated deep audit (Claude)
**Scope**: Every source file — routes, services, middleware, utils, jobs, frontend JS, database schema, tests
**Mode**: READ-ONLY — no changes made
**Codebase**: SqTools (Square POS middleware for perishable retail)

---

## Executive Summary

The codebase has made significant progress since the api.js monolith split and 11 remediation packages. Security fundamentals are solid — parameterized SQL is universal, multi-tenant isolation is consistent, token encryption is textbook, and rate limiting is comprehensive. The recent migrations (049–058) show improving discipline.

However, the codebase is not open-source ready. The audit found **~210 findings** across 10 categories:

| Severity | Count | Key Concerns |
|----------|-------|-------------|
| **CRITICAL** | 10 | File size violations (8 services >3x limit), test coverage gaps (84% routes untested) |
| **HIGH** | 25 | XSS in 2 frontend files, subscription auth bypass via header, open redirect, N+1 queries, 55/75 services untested |
| **MEDIUM** | ~95 | Business logic in routes, missing response.ok checks (79 fetch calls), hardcoded CAD/Toronto, nullable merchant_id in 14 tables, code duplication |
| **LOW** | ~80 | Dead imports, debug logging, inconsistent patterns, hardcoded config values |

**Bottom line**: Security is A-grade. Architecture is C-grade (too many oversized files). Test coverage is D-grade (critical paths untested, one test file tests nothing real). Open-source readiness is D-grade (JTPets branding, hardcoded locale/currency throughout).

---

## Table of Contents

1. [File Size Rankings](#1-file-size-rankings)
2. [Architecture Review](#2-architecture-review)
3. [Security Findings](#3-security-findings)
4. [Test Coverage Gaps](#4-test-coverage-gaps)
5. [Performance Issues](#5-performance-issues)
6. [Dead Code](#6-dead-code)
7. [Error Handling](#7-error-handling)
8. [Database Schema](#8-database-schema)
9. [Frontend](#9-frontend)
10. [Open-Source Readiness](#10-open-source-readiness)
11. [Top 10 Priority Fixes](#11-top-10-priority-fixes)
12. [What Was Done Well](#12-what-was-done-well)
13. [Remediation Recommendations](#13-remediation-recommendations)

---

## 1. File Size Rankings

**Rule**: Files ≤ 300 lines (CLAUDE.md)
**Reality**: 90 of 219 JS source files (41%) exceed the limit.

### All Files Over 300 Lines (Ranked by Size)

| Rank | Lines | File | Layer | Multiplier |
|------|-------|------|-------|-----------|
| 1 | 2,403 | `utils/database.js` | Utils | 8.0x |
| 2 | 2,354 | `public/js/reorder.js` | Frontend | 7.8x |
| 3 | 2,134 | `routes/loyalty.js` | Routes | 7.1x |
| 4 | 2,103 | `services/expiry/discount-service.js` | Services | 7.0x |
| 5 | 2,074 | `public/js/loyalty.js` | Frontend | 6.9x |
| 6 | 1,950 | `services/delivery/delivery-service.js` | Services | 6.5x |
| 7 | 1,566 | `public/js/gmc-feed.js` | Frontend | 5.2x |
| 8 | 1,467 | `public/js/vendor-catalog.js` | Frontend | 4.9x |
| 9 | 1,464 | `services/loyalty-admin/square-discount-service.js` | Services | 4.9x |
| 10 | 1,413 | `services/reports/loyalty-reports.js` | Services | 4.7x |
| 11 | 1,397 | `services/vendor/catalog-service.js` | Services | 4.7x |
| 12 | 1,316 | `services/webhook-handlers/order-handler.js` | Services | 4.4x |
| 13 | 1,186 | `services/gmc/merchant-service.js` | Services | 4.0x |
| 14 | 1,133 | `server.js` | Core | 3.8x |
| 15 | 1,108 | `services/square/square-catalog-sync.js` | Services | 3.7x |
| 16 | 1,064 | `services/reports/brand-redemption-report.js` | Services | 3.5x |
| 17 | 1,013 | `routes/gmc.js` | Routes | 3.4x |
| 18 | 960 | `services/loyalty-admin/backfill-service.js` | Services | 3.2x |
| 19 | 942 | `routes/delivery.js` | Routes | 3.1x |
| 20 | 918 | `public/js/catalog-workflow.js` | Frontend | 3.1x |
| 21 | 874 | `routes/analytics.js` | Routes | 2.9x |
| 22 | 833 | `services/loyalty-admin/purchase-service.js` | Services | 2.8x |
| 23 | 829 | `public/js/expiry-audit.js` | Frontend | 2.8x |
| 24 | 828 | `services/square/square-inventory.js` | Services | 2.8x |
| 25 | 813 | `services/seniors/seniors-service.js` | Services | 2.7x |
| 26 | 804 | `routes/auth.js` | Routes | 2.7x |
| 27 | 800 | `routes/purchase-orders.js` | Routes | 2.7x |
| 28 | 791 | `routes/subscriptions.js` | Routes | 2.6x |
| 29 | 776 | `public/js/expiry-discounts.js` | Frontend | 2.6x |
| 30 | 765 | `public/js/delivery-route.js` | Frontend | 2.6x |
| 31 | 748 | `middleware/validators/loyalty.js` | Middleware | 2.5x |
| 32 | 724 | `services/square/square-velocity.js` | Services | 2.4x |
| 33 | 716 | `services/square/square-custom-attributes.js` | Services | 2.4x |
| 34 | 701 | `public/js/purchase-orders.js` | Frontend | 2.3x |
| 35 | 700 | `services/loyalty-admin/customer-identification-service.js` | Services | 2.3x |
| 36 | 678 | `public/js/settings.js` | Frontend | 2.3x |
| 37 | 675 | `services/loyalty-admin/reward-service.js` | Services | 2.3x |
| 38 | 675 | `services/catalog/inventory-service.js` | Services | 2.3x |
| 39 | 642 | `services/catalog/variation-service.js` | Services | 2.1x |
| 40 | 641 | `services/ai-autofill-service.js` | Services | 2.1x |
| 41 | 598 | `services/gmc/feed-service.js` | Services | 2.0x |
| 42 | 583 | `routes/sync.js` | Routes | 1.9x |
| 43 | 569 | `jobs/loyalty-audit-job.js` | Jobs | 1.9x |
| 44 | 567 | `utils/merchant-db.js` | Utils | 1.9x |
| 45 | 566 | `public/js/cycle-count.js` | Frontend | 1.9x |
| 46 | 561 | `public/js/inventory.js` | Frontend | 1.9x |
| 47 | 558 | `services/square/square-pricing.js` | Services | 1.9x |
| 48 | 551 | `public/js/catalog-audit.js` | Frontend | 1.8x |
| 49 | 535 | `routes/vendor-catalog.js` | Routes | 1.8x |
| 50 | 534 | `utils/square-webhooks.js` | Utils | 1.8x |
| 51 | 524 | `public/js/expiry.js` | Frontend | 1.7x |
| 52 | 512 | `services/webhook-handlers/loyalty-handler.js` | Services | 1.7x |
| 53 | 511 | `public/js/delivery.js` | Frontend | 1.7x |
| 54 | 510 | `public/js/bundle-manager.js` | Frontend | 1.7x |
| 55 | 501 | `services/bundle-service.js` | Services | 1.7x |
| 56 | 498 | `public/js/label-printer.js` | Frontend | 1.7x |
| 57 | 495 | `services/vendor-dashboard.js` | Services | 1.7x |
| 58 | 490 | `services/square/square-diagnostics.js` | Services | 1.6x |
| 59 | 475 | `services/cart/cart-activity-service.js` | Services | 1.6x |
| 60 | 475 | `routes/cycle-counts.js` | Routes | 1.6x |
| 61 | 472 | `services/loyalty-admin/customer-admin-service.js` | Services | 1.6x |
| 62 | 471 | `routes/square-oauth.js` | Routes | 1.6x |
| 63 | 469 | `services/webhook-handlers/inventory-handler.js` | Services | 1.6x |
| 64 | 467 | `public/js/dashboard.js` | Frontend | 1.6x |
| 65 | 463 | `services/webhook-handlers/catalog-handler.js` | Services | 1.5x |
| 66 | 462 | `routes/expiry-discounts.js` | Routes | 1.5x |
| 67 | 460 | `public/js/driver.js` | Frontend | 1.5x |
| 68 | 451 | `utils/subscription-handler.js` | Utils | 1.5x |
| 69 | 438 | `services/loyalty-admin/webhook-processing-service.js` | Services | 1.5x |
| 70 | 436 | `public/js/vendor-dashboard.js` | Frontend | 1.5x |
| 71 | 435 | `utils/square-subscriptions.js` | Utils | 1.5x |
| 72 | 405 | `services/catalog/audit-service.js` | Services | 1.4x |
| 73 | 398 | `middleware/security.js` | Middleware | 1.3x |
| 74 | 391 | `services/delivery/delivery-stats.js` | Services | 1.3x |
| 75 | 391 | `routes/catalog.js` | Routes | 1.3x |
| 76 | 389 | `services/loyalty-admin/order-intake.js` | Services | 1.3x |
| 77 | 385 | `middleware/validators/delivery.js` | Middleware | 1.3x |
| 78 | 377 | `services/webhook-processor.js` | Services | 1.3x |
| 79 | 374 | `jobs/seniors-day-job.js` | Jobs | 1.2x |
| 80 | 368 | `utils/google-auth.js` | Utils | 1.2x |
| 81 | 363 | `services/inventory/cycle-count-service.js` | Services | 1.2x |
| 82 | 357 | `public/js/admin-subscriptions.js` | Frontend | 1.2x |
| 83 | 357 | `jobs/loyalty-catchup-job.js` | Jobs | 1.2x |
| 84 | 348 | `services/sync-queue.js` | Services | 1.2x |
| 85 | 348 | `services/loyalty-admin/redemption-audit-service.js` | Services | 1.2x |
| 86 | 344 | `middleware/validators/index.js` | Middleware | 1.1x |
| 87 | 339 | `public/js/subscribe.js` | Frontend | 1.1x |
| 88 | 332 | `middleware/merchant.js` | Middleware | 1.1x |
| 89 | 313 | `services/loyalty-admin/offer-admin-service.js` | Services | 1.0x |
| 90 | 307 | `routes/ai-autofill.js` | Routes | 1.0x |

**Distribution**: Services: 39 files | Frontend: 25 files | Routes: 11 files | Utils: 6 files | Middleware: 5 files | Jobs: 3 files | Core: 1 file

---

## 2. Architecture Review

### 2.1 Module Boundary Violations

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| ARCH-1 | `routes/loyalty.js` (all) | **CRITICAL** | 2,134-line route file contains business logic, direct Square API calls, token handling, and discount creation inline. Violates "routes = validation + call service" rule. Should be 5+ thin route files backed by services. |
| ARCH-2 | `routes/analytics.js:95-874` | **CRITICAL** | Reorder suggestions handler is a single ~780-line function. Contains SQL, priority calculation, bundle analysis, image resolution, and vendor config all inline in a route handler. |
| ARCH-3 | `routes/gmc.js` (all) | **HIGH** | 1,013-line route file with business logic inline (feed generation, taxonomy mapping). |
| ARCH-4 | `routes/delivery.js` (all) | **HIGH** | 942-line route file with inline business logic (order queries, route calculation). |
| ARCH-5 | `routes/auth.js` (all) | **HIGH** | 804-line route file with inline user management, password logic. |
| ARCH-6 | `routes/purchase-orders.js` (all) | **HIGH** | 800-line route file with inline PO workflow logic. |
| ARCH-7 | `routes/subscriptions.js` (all) | **HIGH** | 791-line route file with inline subscription management. |
| ARCH-8 | `routes/sync.js` (all) | **MEDIUM** | 583-line route file with inline sync orchestration. |
| ARCH-9 | `routes/vendor-catalog.js` (all) | **MEDIUM** | 535-line route file mixing routing with data transformation. |
| ARCH-10 | `routes/square-oauth.js` (all) | **MEDIUM** | 471-line route file with inline OAuth flow logic. |

### 2.2 Service Responsibility Violations

| ID | File | Severity | Description |
|----|------|----------|-------------|
| ARCH-11 | `services/expiry/discount-service.js` | **CRITICAL** | 2,103 lines. Mixes tier evaluation, Square discount CRUD, automation orchestration, settings management, and tier seed init. Needs 5+ modules. |
| ARCH-12 | `services/delivery/delivery-service.js` | **CRITICAL** | 1,950 lines. Combines order CRUD, route generation (OpenRouteService), POD image management, GTIN enrichment, customer lookup. At least 4 responsibilities. |
| ARCH-13 | `services/loyalty-admin/square-discount-service.js` | **CRITICAL** | 1,464 lines. Customer group creation, discount/pricing rule CRUD, redemption detection, validation, and cleanup. |
| ARCH-14 | `services/reports/loyalty-reports.js` | **CRITICAL** | 1,413 lines. Vendor receipt generation, audit CSV export, merchant info lookup, and HTML rendering in one file. |
| ARCH-15 | `services/vendor/catalog-service.js` | **CRITICAL** | 1,397 lines. CSV/XLSX parsing, column mapping, UPC matching, price comparison, batch management, report generation. |
| ARCH-16 | `services/webhook-handlers/order-handler.js` | **CRITICAL** | 1,316 lines. Order sync, delivery routing, loyalty processing, cart tracking, payment/refund events, fulfillment updates. |
| ARCH-17 | `services/gmc/merchant-service.js` | **CRITICAL** | 1,186 lines. OAuth management, product sync, local inventory sync, sync logging, connection testing. |
| ARCH-18 | `services/square/square-catalog-sync.js` | **CRITICAL** | 1,108 lines. Full and delta sync logic, deletion detection, variation/vendor/custom-attribute processing. |

### 2.3 Coupling Issues

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| ARCH-19 | `utils/database.js:2371-2402` | **LOW** | database.js re-exports `getMerchantSettings` from `services/merchant/`. Utils should not depend on services. |
| ARCH-20 | `webhook-handlers/catalog-handler.js:190-270` | **MEDIUM** | Vendor ID migration logic duplicates `migrateVendorFKs()` from `square/square-vendors.js`. |
| ARCH-21 | `square/index.js:41-54` | **LOW** | Spread operator aggregation across 10 modules risks silent namespace collisions. |
| ARCH-22 | `middleware/subscription-check.js` + `middleware/merchant.js:146-167` | **MEDIUM** | Two separate subscription verification systems with confusing naming overlap. |

### 2.4 Function Length Violations (>100 lines)

| ID | File:Line | Lines | Description |
|----|-----------|-------|-------------|
| ARCH-23 | `routes/analytics.js:95` | ~780 | Reorder suggestions — entire handler |
| ARCH-24 | `square/square-diagnostics.js:29` | ~212 | `fixLocationMismatches()` |
| ARCH-25 | `square/square-diagnostics.js:250` | ~165 | `fixInventoryAlerts()` |
| ARCH-26 | `webhook-handlers/catalog-handler.js:152` | ~155 | `_handleVendorChange()` |
| ARCH-27 | `expiry/discount-service.js:171` | ~130 | `evaluateAllVariations()` |
| ARCH-28 | `webhook-handlers/order-handler.js:151` | ~115 | `handleOrderCreatedOrUpdated()` |

---

## 3. Security Findings

### 3.1 HIGH Severity

| ID | File:Line | Description |
|----|-----------|-------------|
| SEC-1 | `middleware/subscription-check.js:66-73` | **Auth bypass via header/query param**: `getSubscriberEmail()` accepts identity from `X-Subscriber-Email` header and `req.query.email`, in addition to session. An attacker can bypass subscription checks by setting this header to any valid subscriber's email. Only session should be trusted. |
| SEC-2 | `routes/square-oauth.js:74` | **Open redirect**: `req.query.redirect` is used for post-OAuth redirect without validation against an allowlist of paths. Attacker can craft a URL that redirects to a malicious domain after successful OAuth. |
| SEC-3 | `public/js/sales-velocity.js:95-99` | **XSS**: 4 fields (`item_name`, `variation_name`, `sku`, `location_name`) inserted into innerHTML without `escapeHtml()`. These are user-controlled Square catalog values. |
| SEC-4 | `public/js/cycle-count-history.js:136-139` | **XSS**: 4 fields (`item_name`, `variation_name`, `sku`, `category_name`) inserted into innerHTML without `escapeHtml()`. |
| SEC-5 | `public/js/vendor-catalog.js:1123` | **XSS via script injection**: `JSON.stringify(report.priceUpdates)` injected into a `<script>` block inside `window.open()`. If any field contains `</script>`, it breaks out of the script context. |

### 3.2 MEDIUM Severity

| ID | File:Line | Description |
|----|-----------|-------------|
| SEC-6 | `utils/google-auth.js:229-246` | Google OAuth tokens stored in plaintext. Square tokens are AES-256-GCM encrypted; Google tokens are not. |
| SEC-7 | `utils/link-existing-subscribers.js:78` | Password reset tokens stored as plaintext hex. Best practice: store SHA-256 hash. |
| SEC-8 | `utils/database.js:167-220` | `batchUpsert()` interpolates table/column names without sanitization. Callers use hardcoded strings today, but no enforcement exists. |
| SEC-9 | `utils/merchant-db.js:451-465` | `MerchantDB.update()` interpolates object keys into SET clauses without `_isValidColumnName()` validation. |
| SEC-10 | `webhook-handlers/oauth-handler.js:41` | Sets `square_access_token = 'REVOKED'` (plaintext) in column that normally holds encrypted tokens. May cause confusing decryption errors. |
| SEC-11 | `public/js/login.js:18,46` | Open redirect: `returnUrl` from query params used for `window.location.href` without validating it's a relative path. |
| SEC-12 | `public/js/logs.js:68-71` | 3 fields from server logs inserted into innerHTML without `escapeHtml()`. |
| SEC-13 | `public/js/delivery-settings.js:108` | `showMessage()` uses innerHTML with unescaped `error.message`. |

### 3.3 LOW Severity

| ID | File:Line | Description |
|----|-----------|-------------|
| SEC-14 | `utils/image-utils.js:37-39` | `resolveImageUrls()` queries `images` table without `merchant_id` filter. Violates CLAUDE.md rule. |
| SEC-15 | `utils/square-webhooks.js:130-134` | Falls back to unencrypted token if not encrypted. Should warn when this happens. |
| SEC-16 | `services/square/square-vendors.js:40` | Uses `${table}` template literal in SQL. Tables come from hardcoded array (safe), but pattern diverges from parameterized-only policy. |
| SEC-17 | `services/loyalty-admin/square-discount-service.js` (multiple) | 11 direct `fetchWithTimeout()` calls to Square API bypassing centralized client. Misses retry logic and rate-limit handling. |

---

## 4. Test Coverage Gaps

### 4.1 Overall Statistics

| Metric | Value |
|--------|-------|
| Total test files | 44 |
| Total route files | 25 |
| Route files with tests | 4 (16%) |
| Total service files | ~75 |
| Service files with tests | ~20 (27%) |
| Job files | 12 |
| Job files with tests | 1 (8%) — and it only tests cron registration, not job logic |
| Integration tests | 0 |

### 4.2 Routes Without Tests (21 of 25)

| ID | Route File | Critical? |
|----|-----------|-----------|
| TEST-1 | `routes/loyalty.js` | **YES** — 2,134 lines of untested business logic |
| TEST-2 | `routes/analytics.js` | **YES** — reorder suggestions, core business feature |
| TEST-3 | `routes/sync.js` | **YES** — core data pipeline |
| TEST-4 | `routes/purchase-orders.js` | **YES** — PO workflow |
| TEST-5 | `routes/gmc.js` | YES — Google Merchant Center integration |
| TEST-6 | `routes/expiry-discounts.js` | YES — automated pricing changes |
| TEST-7 | `routes/catalog.js` | YES — catalog management |
| TEST-8 | `routes/square-oauth.js` | YES — OAuth flow |
| TEST-9 | `routes/bundles.js` | No |
| TEST-10 | `routes/cart-activity.js` | No |
| TEST-11 | `routes/cycle-counts.js` | No |
| TEST-12 | `routes/driver-api.js` | No |
| TEST-13 | `routes/google-oauth.js` | No |
| TEST-14 | `routes/labels.js` | No |
| TEST-15 | `routes/logs.js` | No |
| TEST-16 | `routes/merchants.js` | No |
| TEST-17 | `routes/seniors.js` | No |
| TEST-18 | `routes/settings.js` | No |
| TEST-19 | `routes/square-attributes.js` | No |
| TEST-20 | `routes/vendor-catalog.js` | No |
| TEST-21 | `routes/webhooks.js` | No |

### 4.3 Critical Untested Business Paths

| ID | Path | Files | Risk |
|----|------|-------|------|
| TEST-22 | Catalog sync pipeline | `routes/sync.js`, `services/square/square-catalog-sync.js`, `services/square/square-sync-orchestrator.js` | Core data integrity — if sync breaks, everything breaks |
| TEST-23 | Inventory management | `services/catalog/inventory-service.js`, `services/square/square-inventory.js` | Stock levels are the core feature |
| TEST-24 | Expiry discount automation | `services/expiry/discount-service.js`, `jobs/expiry-discount-job.js` | Automated pricing changes to Square catalog — mistakes cost real money |
| TEST-25 | Loyalty reward lifecycle | `services/loyalty-admin/reward-service.js`, `purchase-service.js`, `redemption-audit-service.js` | Partial coverage only (intake + split-row + backfill tested) |
| TEST-26 | Square API client layer | All 10 files in `services/square/` | Zero tests for any Square API integration |
| TEST-27 | All 11 job files | `jobs/*.js` (except cron-scheduler registration) | Background automation completely untested |

### 4.4 Test Quality Issues

| ID | File | Severity | Description |
|----|------|----------|-------------|
| TEST-28 | `__tests__/routes/subscriptions.test.js` | **HIGH** | 849 lines that **test nothing real**. Tests verify JavaScript operators work (`'DiScOuNt'.toUpperCase() === 'DISCOUNT'`, `99 < 100`), not actual application code. Does not import or test any function from `routes/subscriptions.js`. Provides false confidence — would pass even if the subscription routes were deleted. |
| TEST-29 | `__tests__/security/multi-tenant-isolation.test.js` | **MEDIUM** | Most tests verify their own mock queries contain `merchant_id`. They construct SQL inline and assert the string contains `merchant_id`. Doesn't test actual routes/services. The middleware tests (lines 131-196, 472-500) are genuinely useful. |
| TEST-30 | `__tests__/jobs/cron-scheduler.test.js` | **MEDIUM** | Only tests cron registration count, not that correct handlers run at correct schedules. |

### 4.5 Gold Standard Tests (for reference)

- `__tests__/routes/delivery-completion.test.js` — imports real router, uses supertest, tests state transitions, edge cases, idempotency
- `__tests__/routes/vendor-dashboard.test.js` — imports real service functions, verifies merchant_id filtering, SQL injection protection

---

## 5. Performance Issues

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| PERF-1 | `services/square/square-velocity.js:168` | **HIGH** | **N+1 query**: Individual `INSERT ... ON CONFLICT` per variation per period inside a loop. For 500 variations × 3 locations, this is ~1,500 individual INSERT statements per period. Should use batch INSERT or `unnest()`. |
| PERF-2 | `services/square/square-locations.js:32-57` | **MEDIUM** | N+1: Individual INSERT per location in a loop. Low impact (few locations) but inconsistent pattern. |
| PERF-3 | `services/square/square-vendors.js:129-163` | **MEDIUM** | N+1: Individual INSERT per vendor in a pagination loop. |
| PERF-4 | `services/webhook-handlers/inventory-handler.js:290-313` | **MEDIUM** | N+1: Individual INSERT per committed inventory line item inside a transaction. |
| PERF-5 | `services/webhook-handlers/catalog-handler.js:435-450` | **MEDIUM** | N+1: Individual UPDATE per stale bundle component in `reconcileBundleComponents()`. |
| PERF-6 | `services/vendor-dashboard.js:88` | **MEDIUM** | `computeReorderValues()` runs heavy SQL with multiple JOINs, correlated subqueries, and window functions. 3-4 sequential heavyweight queries per request. |
| PERF-7 | `routes/analytics.js:95-874` | **HIGH** | Reorder suggestions: massive single SQL query (~100 lines) followed by N+1 image lookups and inline bundle analysis. On large catalogs this could timeout. |
| PERF-8 | `routes/loyalty.js:880-960` | **MEDIUM** | Audit CSV export: unbounded query with no pagination. For stores with large loyalty history, this could cause memory issues. |
| PERF-9 | `utils/database.js:265-2366` | **MEDIUM** | `ensureSchema()` runs dozens of sequential `SELECT EXISTS` queries on every startup. A versioned migration system would reduce this to a single version check. |
| PERF-10 | `services/webhook-handlers/loyalty-handler.js:131-136,217-226,271-282` | **MEDIUM** | Three separate code paths each create a new `SquareApiClient` and call `initialize()`, fetching the merchant token from DB each time. |
| PERF-11 | `jobs/loyalty-catchup-job.js:110-140` | **MEDIUM** | Caps at 500 orders with no warning if more exist. Orders beyond 500 are silently skipped. |

---

## 6. Dead Code

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| DEAD-1 | `routes/square-oauth.js:445-466` | **MEDIUM** | `getValidAccessToken()` defined and exported but never called anywhere. |
| DEAD-2 | `services/loyalty-admin/customer-admin-service.js:138` | **MEDIUM** | `lookupCustomerFromLoyalty()` — 0 callers. Exported but never used. |
| DEAD-3 | `services/loyalty-admin/customer-admin-service.js:161` | **MEDIUM** | `lookupCustomerFromFulfillmentRecipient()` — 0 callers. |
| DEAD-4 | `services/loyalty-admin/customer-admin-service.js:184` | **MEDIUM** | `lookupCustomerFromOrderRewards()` — 0 callers. |
| DEAD-5 | `server.js:229-243` | **LOW** | `podUpload` multer config defined but never used. Routes define their own. |
| DEAD-6 | `server.js:15` | **LOW** | `multer` import only used by dead `podUpload`. |
| DEAD-7 | `server.js:34` | **LOW** | `expiryDiscount` import never used in server.js. |
| DEAD-8 | `server.js:36` | **LOW** | `deliveryApi` import never used in server.js. |
| DEAD-9 | `server.js:37` | **LOW** | `loyaltyService` import never used in server.js. |
| DEAD-10 | `server.js:38` | **LOW** | `loyaltyReports` import never used in server.js. |
| DEAD-11 | `server.js:39` | **LOW** | `gmcApi` import never used in server.js. |
| DEAD-12 | `server.js:31` | **LOW** | `subscriptionHandler` import never used in server.js. |
| DEAD-13 | `server.js:563-639` | **LOW** | ~75 lines of "EXTRACTED" comments documenting code moved long ago. Inflates file size. |
| DEAD-14 | `utils/email-notifier.js:8` | **LOW** | `errorCount` initialized but never incremented or read. |
| DEAD-15 | 9 files in `utils/` | **LOW** | Deprecated re-export stubs (`delivery-api.js`, `google-sheets.js`, `gmc-feed.js`, etc.) marked for removal but still present. |

---

## 7. Error Handling

### 7.1 Missing asyncHandler

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| ERR-1 | `routes/square-oauth.js:68` | **HIGH** | `/connect` uses manual try/catch with `async (req, res)` instead of `asyncHandler`. Unhandled rejections will crash or hang. |
| ERR-2 | `routes/square-oauth.js:111` | **HIGH** | `/callback` (~226-line handler) uses manual try/catch instead of `asyncHandler`. |
| ERR-3 | `routes/google-oauth.js:78` | **MEDIUM** | `/google/callback` uses manual try/catch instead of `asyncHandler`. |
| ERR-4 | `routes/settings.js:96` | **MEDIUM** | `/settings/merchant/defaults` uses bare `async (req, res)` without `asyncHandler`. |
| ERR-5 | `routes/merchants.js:79` | **MEDIUM** | `/merchants/context` uses bare `async (req, res)` without `asyncHandler`. |

### 7.2 Silent Failures

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| ERR-6 | `services/webhook-handlers/loyalty-handler.js:159-161` | **MEDIUM** | 4 silent returns without logging when conditions aren't met. Events are dropped with no trace. |
| ERR-7 | `services/webhook-handlers/catalog-handler.js:170,351` | **LOW** | Returns `{ handled: true }` without logging when data is missing. |
| ERR-8 | `routes/logs.js:78-85` | **LOW** | Bare `catch {}` swallows JSON parse errors silently. |
| ERR-9 | `jobs/cron-scheduler.js:160-173` | **LOW** | `setImmediate(async () => { await ... })` swallows rejections from startup functions. |

### 7.3 Process Stability

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| ERR-10 | `utils/database.js:27-29` | **MEDIUM** | Pool error handler calls `process.exit(-1)` on any idle client error. A transient network blip kills the entire process. Should distinguish fatal vs transient errors. |
| ERR-11 | `services/merchant/settings-service.js:184-185` | **LOW** | Potential infinite recursion if `getMerchantSettings()` creates defaults but subsequent retry still finds no rows. |

### 7.4 Frontend Fetch Error Handling

| ID | Description | Severity |
|----|-------------|----------|
| ERR-12 | ~79 of 183 `fetch()` calls across 30 frontend files do not check `response.ok` before calling `.json()`. Errors produce confusing JSON parse failures instead of meaningful messages. | **MEDIUM** |

Key affected files: `vendor-catalog.js` (3), `expiry-discounts.js` (8), `inventory.js` (1), `catalog-audit.js` (1), `logs.js` (2), `merchants.js` (1), `dashboard.js` (multiple), `vendor-dashboard.js` (1), `deleted-items.js` (1), `cycle-count-history.js` (1).

---

## 8. Database Schema

### 8.1 Nullable merchant_id on Core Tables

| ID | Severity | Description |
|----|----------|-------------|
| DB-1 | **MEDIUM** | **14 core tables** have `merchant_id INTEGER REFERENCES merchants(id)` **without NOT NULL**: `sync_history`, `locations`, `vendors`, `categories`, `images`, `items`, `variations`, `variation_vendors`, `inventory_counts`, `sales_velocity`, `variation_location_settings`, `purchase_orders`, `purchase_order_items`. These predate multi-tenant and were retrofitted without making the column required. Newer tables (delivery_*, loyalty_*, committed_inventory) correctly use NOT NULL. |

### 8.2 Missing ON DELETE CASCADE

| ID | Severity | Description |
|----|----------|-------------|
| DB-2 | **MEDIUM** | The same 14 core tables use `REFERENCES merchants(id)` with no ON DELETE action. Newer tables properly use `ON DELETE CASCADE`. If a merchant is ever deleted, child rows become orphans. |

### 8.3 Tables Without merchant_id

| ID | File:Line | Severity | Description |
|----|-----------|----------|-------------|
| DB-3 | `schema.sql:1018-1104` | **HIGH** | `subscribers`, `subscription_payments`, `subscription_events`, `subscription_plans` have no `merchant_id`. These are SaaS billing tables (not merchant data), but there's no link between who subscribes and which merchant they manage. `subscription_events.subscriber_id` uses `ON DELETE SET NULL` which orphans events. |
| DB-4 | `schema.sql:1836-1849` | **MEDIUM** | `bundle_components` has no direct `merchant_id`. Relies on FK to `bundle_definitions(id)` for tenant isolation. Direct queries can't filter by merchant without a JOIN. |

### 8.4 Schema Inconsistencies

| ID | Severity | Description |
|----|----------|-------------|
| DB-5 | **LOW** | Timestamp types mixed: core tables use `TIMESTAMP DEFAULT CURRENT_TIMESTAMP`, newer tables use `TIMESTAMPTZ DEFAULT NOW()`. Can cause timezone bugs when comparing across tables. |
| DB-6 | **LOW** | `expiry_discount_audit_log.variation_id` is TEXT with no FK to `variations(id)`. Orphaned audit rows possible if variation deleted. |
| DB-7 | **LOW** | `bundle_definitions.merchant_id` has no `ON DELETE CASCADE` despite being a newer table. |

### 8.5 Missing Indexes

| ID | Severity | Description |
|----|----------|-------------|
| DB-8 | **LOW** | `committed_inventory` has no index on `invoice_id` alone. Invoice lookups during reconciliation may be slow. |
| DB-9 | **LOW** | `expiry_discount_audit_log` missing composite index on `(merchant_id, variation_id)`. |

### 8.6 Concurrency Safety (Jobs)

| ID | Severity | Description |
|----|----------|-------------|
| DB-10 | **MEDIUM** | No jobs have concurrency guards (advisory locks, is_running flags). If PM2 runs multiple instances or a job exceeds its cron interval, duplicate processing occurs. Sync job and loyalty catchup most at risk. |

---

## 9. Frontend

### 9.1 File Size Summary

25 of 37 frontend JS files exceed the 300-line limit. The top 4 files account for 7,461 lines (37% of all frontend JS):

| File | Lines | Concerns |
|------|-------|----------|
| `reorder.js` | 2,354 | Rendering, vendor grouping, expiry, PO modal, print, batch actions |
| `loyalty.js` | 2,074 | Program mgmt, offer CRUD, rewards, customer lookup, discount validation |
| `gmc-feed.js` | 1,566 | Feed mgmt, category mapping, exclusions, settings, sync |
| `vendor-catalog.js` | 1,467 | Catalog search, UPC lookup, batch mgmt, import, price report |

### 9.2 Code Duplication

| Pattern | Files | Count | Status |
|---------|-------|-------|--------|
| `showToast()` | 7 frontend files | 7 copies | NEW — needs shared `utils/toast.js` |
| `escapeJsString()` | 7 frontend files | 7 copies | NEW — should be in `utils/escape.js` |
| `formatDate()` | 6 frontend files | 6 copies | Tracked as BACKLOG-26 |
| Currency formatting | 14+ files | Mixed patterns | Tracked as BACKLOG-23 |

### 9.3 Polling

All polling implementations properly pause on `visibilitychange` and resume on focus. This is well-implemented.

### 9.4 Debug Logging

20 `console.log` calls across 8 files (6 in `delivery-route.js`, 4 in `label-printer.js`). Should be removed for production.

---

## 10. Open-Source Readiness

### 10.1 JTPets Branding (Must Remove)

| ID | File:Line | Description |
|----|-----------|-------------|
| OSS-1 | `public/login.html:217` | `Created by <a href="https://jtpets.ca">JTPets.ca</a>` |
| OSS-2 | `public/login.html:221` | Square referral `squareup.com/i/JTPETS0000` |
| OSS-3 | `public/index.html:497,500` | JTPets.ca credit + JTPETS0000 referral |
| OSS-4 | `public/dashboard.html:869,871,898` | JTPets.ca credit + JTPETS0000 referral (×2) |
| OSS-5 | `public/support.html:329` | JTPETS0000 referral |
| OSS-6 | `public/merchants.html:519` | JTPETS0000 referral in readonly input |
| OSS-7 | `utils/email-notifier.js:39,84,124,145,215` | `[Square Dashboard Addon]` in email subjects |

### 10.2 Hardcoded Currency (CAD)

| ID | File | Count | Description |
|----|------|-------|-------------|
| OSS-8 | `services/square/square-pricing.js` | 3 | `'CAD'` fallback |
| OSS-9 | `services/loyalty-admin/square-discount-service.js` | 3 | `'CAD'` with TODO comment acknowledging the issue |
| OSS-10 | `services/gmc/merchant-service.js` + `feed-service.js` | 3 | `'CAD'` in product feeds |
| OSS-11 | `services/square/square-catalog-sync.js` | 2 | `'CAD'` in sync |
| OSS-12 | `services/label/zpl-generator.js` | 1 | `'CAD'` in labels |
| OSS-13 | `utils/square-subscriptions.js:164` | 1 | Subscription plan hardcodes CAD |
| OSS-14 | Multiple frontend files | 6+ | `'CAD'` defaults, `'en-CA'` locale |

### 10.3 Hardcoded Timezone (America/Toronto)

| ID | File | Description |
|----|------|-------------|
| OSS-15 | `utils/logger.js:4` | `process.env.TZ = 'America/Toronto'` — sets globally, affects all date operations |
| OSS-16 | `services/seniors/seniors-service.js:19,26,293` | Hardcoded unconditionally |
| OSS-17 | `services/expiry/discount-service.js` | 5 occurrences (uses as fallback) |
| OSS-18 | `routes/seniors.js:59` | Hardcoded |
| OSS-19 | `routes/logs.js:28` | Hardcoded |

### 10.4 Hardcoded Square API Version

| ID | File | Description |
|----|------|-------------|
| OSS-20 | `services/loyalty-admin/` (multiple files) | 17 occurrences of `'Square-Version': '2025-01-16'` bypassing centralized `SQUARE_API_VERSION` constant |
| OSS-21 | `services/loyalty-admin/redemption-audit-service.js:32` | Outdated version `'2024-01-18'` (over a year behind) |

### 10.5 Other Hardcoded Values

| ID | File | Description |
|----|------|-------------|
| OSS-22 | `services/ai-autofill-service.js:216-270` | Pet-store-specific AI prompt examples ("Cat Food - Wet", "Dog Treats", "ACANA Chunks in Broth") |
| OSS-23 | `config/constants.js:82-89` | Seniors discount config (MIN_AGE: 60, 10%, "Seniors 60 Plus") |
| OSS-24 | `services/delivery/delivery-service.js:26` | Hardcoded OpenRouteService URL |
| OSS-25 | `services/gmc/merchant-service.js:520` | Fallback URL `https://example.com` for GMC products |
| OSS-26 | `utils/subscription-handler.js:41` | Fallback subscription prices (9999/999) |
| OSS-27 | `routes/analytics.js:38` | Valid period days hardcoded to `[91, 182, 365]` |

---

## 11. Top 10 Priority Fixes

Ranked by **risk × effort** (highest impact first):

| Rank | ID(s) | Category | Description | Effort | Risk |
|------|-------|----------|-------------|--------|------|
| **1** | SEC-1 | Security | **Remove `X-Subscriber-Email` header and `req.query.email` from `getSubscriberEmail()`** in `subscription-check.js`. Auth bypass vector — attacker can impersonate any subscriber. | S | CRITICAL |
| **2** | SEC-3, SEC-4 | Security | **Add `escapeHtml()` to `sales-velocity.js` and `cycle-count-history.js`**. 8 XSS vectors via unescaped Square catalog data in innerHTML. Both files already load `escape.js`. | S | HIGH |
| **3** | SEC-5 | Security | **Fix `JSON.stringify` script injection in `vendor-catalog.js:1123`**. Add `.replace(/<\//g, '<\\/')` after JSON.stringify to prevent `</script>` breakout. | S | HIGH |
| **4** | SEC-2, SEC-11 | Security | **Validate redirect URLs** in `square-oauth.js:74` and `login.js:18,46`. Ensure they're relative paths (start with `/`, no `//`). | S | HIGH |
| **5** | ERR-1, ERR-2 | Reliability | **Add `asyncHandler` to `square-oauth.js` `/connect` and `/callback` routes**. These are the most complex handlers in the file and currently risk unhandled rejections. | S | HIGH |
| **6** | TEST-28 | Testing | **Replace `subscriptions.test.js` entirely**. 849 lines that test JavaScript operators, not application code. Rewrite to import and test actual route/service functions. | M | HIGH |
| **7** | DB-1 | Database | **Make nullable `merchant_id` columns NOT NULL** on 14 core tables via migration. Add `WHERE merchant_id IS NOT NULL` check first, then `ALTER COLUMN SET NOT NULL`. | M | MEDIUM |
| **8** | PERF-1 | Performance | **Batch N+1 INSERT pattern in `square-velocity.js`**. Replace per-variation INSERT loop with batch INSERT using `unnest()` or multi-row VALUES. Highest-impact perf fix. | M | MEDIUM |
| **9** | OSS-1–7 | Open-source | **Remove JTPets branding**. Replace hardcoded referral links and credits with configurable values (env vars or merchant settings). | S | MEDIUM |
| **10** | DEAD-6–12 | Cleanup | **Remove 7 dead imports from `server.js`** + dead `podUpload` config + ~75 lines of "EXTRACTED" comments. Reduces server.js by ~100 lines. | S | LOW |

---

## 12. What Was Done Well

Credit where it's due — these areas are genuinely solid:

| Area | Assessment |
|------|-----------|
| **Parameterized SQL** | 100% compliance. Every database query uses `$1, $2, ...` placeholders. No string concatenation of user input into SQL found anywhere. |
| **Multi-tenant isolation** | `MerchantDB` systematically adds `merchant_id`. `loadMerchantContext` verifies user-to-merchant access via `user_merchants` join. Consistent across all layers. |
| **Token encryption** | `token-encryption.js`: Textbook AES-256-GCM with proper IV generation, auth tag validation, format validation. No issues. |
| **Password handling** | bcrypt with 12 rounds. `crypto.randomInt()` for generation (not Math.random). Fisher-Yates shuffle. |
| **Rate limiting** | 7 tiers (general, login, password reset, webhook, delivery, delivery-strict, sensitive). Login uses composite IP+email key. |
| **CSP** | No `unsafe-inline` or `unsafe-eval` for scripts. Proper `frameguard: deny`, `noSniff`, HSTS in production. |
| **OAuth state management** | Cryptographic random state, DB-stored with expiry, single-use enforcement, user+merchant binding. |
| **Validation layer** | 25 validator files covering all routes. Custom sanitization, null byte removal, range checks. |
| **Webhook security** | Timing-safe HMAC-SHA256 signature verification. In-memory event lock + DB idempotency for dedup. |
| **Pagination guards** | All pagination loops include `MAX_PAGINATION_ITERATIONS` to prevent infinite loops. |
| **Idempotency keys** | All Square API mutation calls use `generateIdempotencyKey()`. |
| **Frontend escaping** | `escapeHtml()` used consistently across 20+ files (with exceptions noted in SEC-3/4). |
| **Polling hygiene** | All polling pauses on `visibilitychange` and resumes on focus. |
| **Error class hierarchy** | Clean operational vs programming error distinction via `isOperational` flag. |
| **Recent migrations** | 049–058 show proper NOT NULL, unique indexes, retroactive constraint fixes. Improving discipline. |
| **Well-structured small modules** | `seniors/age-calculator.js` (123 lines), `catalog/reorder-math.js` (108 lines), `loyalty-admin/constants.js` (56 lines), `loyalty-admin/settings-service.js` (108 lines). Gold standard examples. |
| **Gold standard routes** | `bundles.js`, `cart-activity.js`, `labels.js`, `driver-api.js`, `webhooks/square.js` (43 lines) — thin, properly structured. |

---

## 13. Remediation Recommendations

### Phase 1: Security Fixes (1-2 days)

| Item | Files | Effort |
|------|-------|--------|
| Fix subscription auth bypass (SEC-1) | `middleware/subscription-check.js` | 30 min |
| Fix XSS in sales-velocity.js and cycle-count-history.js (SEC-3, SEC-4) | 2 frontend files | 30 min |
| Fix JSON.stringify script injection (SEC-5) | `public/js/vendor-catalog.js` | 15 min |
| Validate redirect URLs (SEC-2, SEC-11) | `routes/square-oauth.js`, `public/js/login.js` | 30 min |
| Add asyncHandler to OAuth routes (ERR-1, ERR-2) | `routes/square-oauth.js` | 30 min |
| Encrypt Google OAuth tokens (SEC-6) | `utils/google-auth.js` | 1 hour |

### Phase 2: Test Coverage (1 week)

| Item | Priority |
|------|----------|
| Replace `subscriptions.test.js` with real tests | HIGH |
| Add tests for sync pipeline (`routes/sync.js`, `square-catalog-sync.js`) | HIGH |
| Add tests for inventory management | HIGH |
| Add tests for loyalty.js route (or split first, then test) | HIGH |
| Add tests for expiry discount automation | MEDIUM |
| Add tests for purchase-orders route | MEDIUM |

### Phase 3: Architecture (2-3 weeks, incremental)

Split oversized files on touch (refactor-on-touch policy):

| File | Lines | Suggested Split |
|------|-------|----------------|
| `routes/loyalty.js` | 2,134 | 5 thin route files + loyalty services |
| `routes/analytics.js` | 874 | Extract reorder-suggestions-service.js |
| `services/expiry/discount-service.js` | 2,103 | tier-evaluator, discount-crud, automation, settings, seeder |
| `services/delivery/delivery-service.js` | 1,950 | order-crud, route-generator, pod-manager, customer-lookup |
| `server.js` | 1,133 | Remove 7 dead imports + 75 comment lines = ~1,050. Still needs attention. |

### Phase 4: Database Migration (1 day)

| Item | Priority |
|------|----------|
| Add NOT NULL to 14 core table `merchant_id` columns | MEDIUM |
| Add ON DELETE CASCADE to 14 core tables | MEDIUM |
| Fix timestamp inconsistency (TIMESTAMP vs TIMESTAMPTZ) | LOW |

### Phase 5: Open-Source Prep (1-2 days)

| Item | Priority |
|------|----------|
| Remove JTPets branding from 6 HTML files | HIGH |
| Centralize currency/locale into merchant settings | MEDIUM |
| Centralize timezone (remove `process.env.TZ` global set) | MEDIUM |
| Consolidate Square API version strings | LOW |
| Make AI prompt templates configurable | LOW |
| Extract shared frontend utils (showToast, escapeJsString, formatDate) | LOW |

---

## Appendix: Files Audited

- **Routes**: 27 files (including `webhooks/square.js`)
- **Services**: 75 files across 14 subdirectories
- **Middleware**: 6 core files + 25 validator files
- **Utils**: 32 files
- **Jobs**: 12 files
- **Frontend JS**: 37 files
- **Frontend HTML**: 4 key files (sampled)
- **Database**: `schema.sql` + migrations 049-058
- **Tests**: 44 test files
- **Config**: `constants.js`, `jest.config.js`, `ecosystem.config.js`

**Total files read**: ~260+
