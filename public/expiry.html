<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expiration Tracker - Square Dashboard Addon</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
      line-height: 1.4;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #2563eb;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .back-button {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 13px;
      white-space: nowrap;
    }
    .back-button:hover { background: rgba(255,255,255,0.3); }
    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .header h1 { font-size: 20px; }
      .header-buttons {
        justify-content: center;
      }
      .back-button {
        flex: 1;
        text-align: center;
        min-width: 100px;
      }
    }
    .stats-bar {
      background: #1f2937;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    .stat { text-align: center; min-width: 100px; }
    .stat-number { font-size: 24px; font-weight: bold; color: #10b981; }
    .stat-label { font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .controls {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls select, .controls button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      min-height: 40px;
    }
    .controls button {
      background: #059669;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    .controls button:hover { background: #047857; }
    .sync-button { background: #dc2626 !important; margin-left: auto; }
    .sync-button:hover { background: #b91c1c !important; }
    .table-container {
      overflow-x: auto;
      max-height: 70vh;
      overflow-y: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .product-image { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    .product-name { max-width: 300px; white-space: normal; font-weight: 500; }
    .variation-name { font-size: 13px; color: #6b7280; font-style: italic; }
    .gtin { font-family: monospace; font-size: 12px; color: #6b7280; }
    .price { font-weight: 600; color: #059669; }
    input[type="date"] {
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      min-height: 36px;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
    .row-changed { background-color: #fef3c7 !important; }
    .date-input-container { position: relative; display: inline-block; }
    .date-confirmation {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    .confirm-btn, .cancel-btn {
      padding: 5px 10px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .confirm-btn { background: #10b981; color: white; }
    .cancel-btn { background: #ef4444; color: white; }
    .save-section {
      padding: 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }
    .pagination {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .pagination button:disabled {
      background: #f9fafb;
      cursor: not-allowed;
      color: #9ca3af;
    }
    .loading { text-align: center; padding: 40px; color: #6b7280; font-style: italic; }
    .review-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .review-btn:hover { background: #2563eb; }
    .review-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .mark-all-reviewed {
      background: #8b5cf6 !important;
    }
    .mark-all-reviewed:hover { background: #7c3aed !important; }
    .review-col { display: none; }
    .review-mode .review-col { display: table-cell; }
    @media (max-width: 900px) {
      .gtin, .variation-name { display: none; }
      .product-image { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Expiration Tracker</h1>
      <div class="header-buttons">
        <a href="expiry-audit.html" class="back-button" style="background: #3b82f6;">Audit Tool</a>
        <a href="expiry-discounts.html" class="back-button" style="background: #dc2626;">Discount Manager</a>
        <a href="/dashboard.html" class="back-button">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat">
        <div class="stat-number" id="stat-total">--</div>
        <div class="stat-label">Total Variations</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-with-data">--</div>
        <div class="stat-label">With Expiration Data</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-never-expires">--</div>
        <div class="stat-label">Never Expires</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-has-expiry">--</div>
        <div class="stat-label">Has Expiry Date</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-expiring">--</div>
        <div class="stat-label">Expiring < 120 Days</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-value">--</div>
        <div class="stat-label">Inventory Value</div>
      </div>
    </div>

    <div class="controls">
      <label>Filter by expiry:</label>
      <select id="expiry-filter" data-change="loadItems">
        <option value="">All items</option>
        <option value="30">Expiring in 30 days</option>
        <option value="60">Expiring in 60 days</option>
        <option value="90">Expiring in 90 days</option>
        <option value="review">Review (91-120 days)</option>
        <option value="120">Expiring in 120 days</option>
        <option value="no-expiry">No expiry set</option>
        <option value="never-expires">Never expires</option>
      </select>

      <label>Category:</label>
      <select id="category-filter" data-change="loadItems">
        <option value="">All categories</option>
      </select>

      <button data-action="loadItems">Refresh</button>
      <button id="mark-all-reviewed-btn" class="mark-all-reviewed" data-action="markAllAsReviewed" style="display: none;">Mark All as Reviewed</button>
      <button class="sync-button" data-action="syncFromSquare">Sync from Square</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Image</th>
            <th>Product Name</th>
            <th>Category</th>
            <th class="variation-col">Variation</th>
            <th class="gtin-col">GTIN/UPC</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Current Expiry</th>
            <th>New Expiry Date</th>
            <th>Never Expires</th>
            <th class="review-col">Reviewed</th>
          </tr>
        </thead>
        <tbody id="items-body">
          <tr><td colspan="10" class="loading">Loading products...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="save-section">
      <div class="pagination">
        <button id="prev-page" data-action="changePage" data-action-param="-1" disabled>Previous</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-page" data-action="changePage" data-action-param="1" disabled>Next</button>
        <span> | Items per page:</span>
        <select id="items-per-page" data-change="changeItemsPerPage">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
      <p style="margin-top: 10px; color: #6b7280;">Changes are auto-saved after confirmation</p>
    </div>
  </div>

  <!-- Error Helper for user-friendly messages -->
  <script src="/js/error-helper.js"></script>
  <!-- Event delegation for CSP compliance -->
  <script src="/js/event-delegation.js"></script>
  <!-- HTML escaping utility -->
  <script src="/js/utils/escape.js"></script>
  <!-- Expiry tracker page logic -->
  <script src="/js/expiry.js"></script>
</body>
</html>
