<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expiration Tracker - Square Dashboard Addon</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
      line-height: 1.4;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #2563eb;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .back-button {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 13px;
      white-space: nowrap;
    }
    .back-button:hover { background: rgba(255,255,255,0.3); }
    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .header h1 { font-size: 20px; }
      .header-buttons {
        justify-content: center;
      }
      .back-button {
        flex: 1;
        text-align: center;
        min-width: 100px;
      }
    }
    .stats-bar {
      background: #1f2937;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    .stat { text-align: center; min-width: 100px; }
    .stat-number { font-size: 24px; font-weight: bold; color: #10b981; }
    .stat-label { font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .controls {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls select, .controls button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      min-height: 40px;
    }
    .controls button {
      background: #059669;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    .controls button:hover { background: #047857; }
    .sync-button { background: #dc2626 !important; margin-left: auto; }
    .sync-button:hover { background: #b91c1c !important; }
    .table-container {
      overflow-x: auto;
      max-height: 70vh;
      overflow-y: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .product-image { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    .product-name { max-width: 300px; white-space: normal; font-weight: 500; }
    .variation-name { font-size: 13px; color: #6b7280; font-style: italic; }
    .gtin { font-family: monospace; font-size: 12px; color: #6b7280; }
    .price { font-weight: 600; color: #059669; }
    input[type="date"] {
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      min-height: 36px;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }
    .row-changed { background-color: #fef3c7 !important; }
    .date-input-container { position: relative; display: inline-block; }
    .date-confirmation {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    .confirm-btn, .cancel-btn {
      padding: 5px 10px;
      margin: 0 2px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .confirm-btn { background: #10b981; color: white; }
    .cancel-btn { background: #ef4444; color: white; }
    .save-section {
      padding: 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }
    .pagination {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .pagination button:disabled {
      background: #f9fafb;
      cursor: not-allowed;
      color: #9ca3af;
    }
    .loading { text-align: center; padding: 40px; color: #6b7280; font-style: italic; }
    .review-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .review-btn:hover { background: #2563eb; }
    .review-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .mark-all-reviewed {
      background: #8b5cf6 !important;
    }
    .mark-all-reviewed:hover { background: #7c3aed !important; }
    .review-col { display: none; }
    .review-mode .review-col { display: table-cell; }
    @media (max-width: 900px) {
      .gtin, .variation-name { display: none; }
      .product-image { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Expiration Tracker</h1>
      <div class="header-buttons">
        <a href="expiry-audit.html" class="back-button" style="background: #3b82f6;">Audit Tool</a>
        <a href="expiry-discounts.html" class="back-button" style="background: #dc2626;">Discount Manager</a>
        <a href="/dashboard.html" class="back-button">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat">
        <div class="stat-number" id="stat-total">--</div>
        <div class="stat-label">Total Variations</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-with-data">--</div>
        <div class="stat-label">With Expiration Data</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-never-expires">--</div>
        <div class="stat-label">Never Expires</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-has-expiry">--</div>
        <div class="stat-label">Has Expiry Date</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-expiring">--</div>
        <div class="stat-label">Expiring < 120 Days</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-value">--</div>
        <div class="stat-label">Inventory Value</div>
      </div>
    </div>

    <div class="controls">
      <label>Filter by expiry:</label>
      <select id="expiry-filter" data-change="loadItems">
        <option value="">All items</option>
        <option value="30">Expiring in 30 days</option>
        <option value="60">Expiring in 60 days</option>
        <option value="90">Expiring in 90 days</option>
        <option value="review">Review (91-120 days)</option>
        <option value="120">Expiring in 120 days</option>
        <option value="no-expiry">No expiry set</option>
        <option value="never-expires">Never expires</option>
      </select>

      <label>Category:</label>
      <select id="category-filter" data-change="loadItems">
        <option value="">All categories</option>
      </select>

      <button data-action="loadItems">Refresh</button>
      <button id="mark-all-reviewed-btn" class="mark-all-reviewed" data-action="markAllAsReviewed" style="display: none;">Mark All as Reviewed</button>
      <button class="sync-button" data-action="syncFromSquare">Sync from Square</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Image</th>
            <th>Product Name</th>
            <th>Category</th>
            <th class="variation-col">Variation</th>
            <th class="gtin-col">GTIN/UPC</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Current Expiry</th>
            <th>New Expiry Date</th>
            <th>Never Expires</th>
            <th class="review-col">Reviewed</th>
          </tr>
        </thead>
        <tbody id="items-body">
          <tr><td colspan="10" class="loading">Loading products...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="save-section">
      <div class="pagination">
        <button id="prev-page" data-action="changePage" data-action-param="-1" disabled>Previous</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-page" data-action="changePage" data-action-param="1" disabled>Next</button>
        <span> | Items per page:</span>
        <select id="items-per-page" data-change="changeItemsPerPage">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
      <p style="margin-top: 10px; color: #6b7280;">Changes are auto-saved after confirmation</p>
    </div>
  </div>

  <!-- Error Helper for user-friendly messages -->
  <script src="/js/error-helper.js"></script>
  <script src="/js/event-delegation.js"></script>

  <script data-cfasync="false">
    let allItems = [];
    let currentPage = 1;
    let itemsPerPage = 50;
    let pendingChanges = new Map();

    // Escape strings for use in JavaScript onclick handlers (single-quoted)
    function escapeJsString(str) {
      if (!str) return '';
      return String(str)
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r');
    }

    // Escape HTML entities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Escape for HTML attributes
    function escapeHtmlAttr(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Handle image fallback (replaces onerror handlers)
    document.addEventListener('error', function(e) {
      if (e.target.tagName === 'IMG' && e.target.dataset.fallback === 'image') {
        e.target.style.display = 'none';
      }
    }, true);

    async function loadItems() {
      const expiryFilter = document.getElementById('expiry-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      const isReviewMode = expiryFilter === 'review';

      // Toggle review mode UI
      const container = document.querySelector('.container');
      const markAllBtn = document.getElementById('mark-all-reviewed-btn');
      if (isReviewMode) {
        container.classList.add('review-mode');
        markAllBtn.style.display = 'inline-block';
      } else {
        container.classList.remove('review-mode');
        markAllBtn.style.display = 'none';
      }

      const tbody = document.getElementById('items-body');
      const colSpan = isReviewMode ? 11 : 10;
      tbody.innerHTML = `<tr><td colspan="${colSpan}" class="loading">Loading...</td></tr>`;

      try {
        let url = '/api/expirations?';
        if (expiryFilter) url += `expiry=${expiryFilter}&`;
        if (categoryFilter) url += `category=${categoryFilter}&`;

        const data = await fetch(url).then(r => r.json());

        // Defensive coding: ensure allItems is always an array
        allItems = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);

        // Hide items with <1 inventory - they can't expire if not in stock
        allItems = allItems.filter(item => (item.quantity || 0) >= 1);

        if (allItems.length === 0) {
          const msg = isReviewMode
            ? 'No items need review. All items in the 91-120 day window have been reviewed.'
            : 'No items found. Please run sync first or adjust filters.';
          tbody.innerHTML = `<tr><td colspan="${colSpan}" class="loading">${msg}</td></tr>`;
          updateStats();
          return;
        }

        currentPage = 1;
        updateStats();
        renderTable();
        updatePagination();

      } catch (error) {
        console.error('Failed to load items:', error);
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="loading">Error: ${error.message}</td></tr>`;
      }
    }

    function updateStats() {
      // Defensive coding: ensure allItems is always an array
      if (!Array.isArray(allItems)) {
        allItems = [];
      }

      const total = allItems.length;

      // With Expiration Data: items that have either expiration_date or does_not_expire set
      const withData = allItems.filter(i => i.expiration_date || i.does_not_expire).length;
      const withDataPercent = total > 0 ? ((withData / total) * 100).toFixed(1) : 0;

      // Never Expires: items where does_not_expire is true
      const neverExpires = allItems.filter(i => i.does_not_expire).length;

      // Has Expiry Date: items with an actual expiration_date
      const hasExpiry = allItems.filter(i => i.expiration_date && !i.does_not_expire).length;

      const today = new Date();
      const in120Days = new Date(today.getTime() + 120*24*60*60*1000);
      const expiring = allItems.filter(i => {
        if (!i.expiration_date || i.does_not_expire) return false;
        const expDate = new Date(i.expiration_date);
        return expDate <= in120Days && expDate >= today;
      }).length;

      const totalValue = allItems.reduce((sum, i) => {
        const qty = i.quantity || 0;
        const price = i.price_money || 0;
        return sum + (qty * price / 100);
      }, 0);

      document.getElementById('stat-total').textContent = total.toLocaleString();
      document.getElementById('stat-with-data').textContent = `${withData.toLocaleString()} (${withDataPercent}%)`;
      document.getElementById('stat-never-expires').textContent = neverExpires.toLocaleString();
      document.getElementById('stat-has-expiry').textContent = hasExpiry.toLocaleString();
      document.getElementById('stat-expiring').textContent = expiring.toLocaleString();
      document.getElementById('stat-value').textContent = '$' + totalValue.toLocaleString('en-CA', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    function renderTable() {
      // Defensive coding: ensure allItems is always an array
      if (!Array.isArray(allItems)) {
        allItems = [];
      }

      const tbody = document.getElementById('items-body');
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = allItems.slice(start, end);
      const isReviewMode = document.getElementById('expiry-filter').value === 'review';
      const colSpan = isReviewMode ? 11 : 10;

      if (pageItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="loading">No products found</td></tr>`;
        return;
      }

      tbody.innerHTML = pageItems.map(item => {
        const expiryValue = item.expiration_date ? item.expiration_date.split('T')[0] : '';
        const imageUrl = item.image_urls && item.image_urls[0] ? item.image_urls[0] : null;
        const safeId = escapeHtmlAttr(item.identifier);

        return `<tr data-id="${safeId}">
          <td>
            ${imageUrl ?
              `<img src="${imageUrl}" class="product-image" data-fallback="image">` :
              '<div style="width:50px;height:50px;background:#f3f4f6;border-radius:4px;"></div>'}
          </td>
          <td class="product-name">${escapeHtml(item.name || '')}</td>
          <td><small>${escapeHtml(item.category_name || '-')}</small></td>
          <td class="variation-name variation-col">${escapeHtml(item.variation || 'Regular')}</td>
          <td class="gtin gtin-col">${escapeHtml(item.gtin || 'N/A')}</td>
          <td class="price">$${((item.price_money || 0) / 100).toFixed(2)}</td>
          <td>${item.quantity || 0}</td>
          <td>${formatDate(item.expiration_date)}</td>
          <td>
            <div class="date-input-container">
              <input type="date" value="${expiryValue}"
                     data-change="showDateConfirmation" data-item-id="${safeId}"
                     ${item.does_not_expire ? 'disabled' : ''}>
              <div id="confirm-${safeId}" class="date-confirmation">
                <button data-action="confirmDateChange" data-action-param="${safeId}" class="confirm-btn">‚úì</button>
                <button data-action="cancelDateChange" data-action-param="${safeId}" class="cancel-btn">‚úï</button>
              </div>
            </div>
          </td>
          <td>
            <input type="checkbox" ${item.does_not_expire ? 'checked' : ''}
                   data-change="updateNeverExpires" data-item-id="${safeId}">
          </td>
          <td class="review-col">
            <button class="review-btn" data-action="markAsReviewed" data-action-param="${safeId}">Mark Reviewed</button>
          </td>
        </tr>`;
      }).join('');
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Not set';
      // Return ISO format (YYYY-MM-DD) - Canadian standard
      return dateStr.split('T')[0];
    }

    // For event delegation: called with (param, element, event) for global functions
    function showDateConfirmation(param, element, event) {
      const input = element;
      const id = input.dataset.itemId;
      const newValue = input.value;
      if (!input.dataset.originalValue) {
        input.dataset.originalValue = input.defaultValue;
      }
      pendingChanges.set(id, { newValue, oldValue: input.dataset.originalValue, inputElement: input });
      document.getElementById(`confirm-${id}`).style.display = 'block';
    }

    function confirmDateChange(id) {
      const pending = pendingChanges.get(id);
      if (pending) {
        updateExpiration(id, pending.newValue);
        pending.inputElement.dataset.originalValue = pending.newValue;
        pendingChanges.delete(id);
        document.getElementById(`confirm-${id}`).style.display = 'none';
      }
    }

    function cancelDateChange(id) {
      const pending = pendingChanges.get(id);
      if (pending) {
        pending.inputElement.value = pending.oldValue;
        pendingChanges.delete(id);
        document.getElementById(`confirm-${id}`).style.display = 'none';
      }
    }

    async function updateExpiration(id, value) {
      try {
        await fetch('/api/expirations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify([{
            variation_id: id,
            expiration_date: value || null,
            does_not_expire: false
          }])
        });

        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) row.classList.add('row-changed');

      } catch (error) {
        alert('Failed to save: ' + error.message);
      }
    }

    // For event delegation: called with (param, element, event) for global functions
    async function updateNeverExpires(param, element, event) {
      const id = element.dataset.itemId;
      const checked = element.checked;
      const row = document.querySelector(`tr[data-id="${id}"]`);
      const dateInput = row.querySelector('input[type="date"]');
      dateInput.disabled = checked;
      if (checked) dateInput.value = '';

      try {
        await fetch('/api/expirations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify([{
            variation_id: id,
            expiration_date: null,
            does_not_expire: checked
          }])
        });

        row.classList.add('row-changed');

      } catch (error) {
        alert('Failed to save: ' + error.message);
      }
    }

    // For event delegation: called with (param, element, event) for global functions
    function changePage(directionParam) {
      const direction = parseInt(directionParam, 10);
      const totalPages = Math.ceil(allItems.length / itemsPerPage);
      currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
      renderTable();
      updatePagination();
    }

    function changeItemsPerPage() {
      itemsPerPage = parseInt(document.getElementById('items-per-page').value);
      currentPage = 1;
      renderTable();
      updatePagination();
    }

    function updatePagination() {
      const totalPages = Math.ceil(allItems.length / itemsPerPage);
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    async function syncFromSquare() {
      const btn = document.querySelector('.sync-button');
      btn.disabled = true;
      btn.textContent = 'Syncing...';

      try {
        await fetch('/api/sync-smart', { method: 'POST' });
        alert('Sync complete!');
        await loadItems();
      } catch (error) {
        alert('Sync failed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sync from Square';
      }
    }

    async function loadCategories() {
      try {
        const categories = await fetch('/api/categories').then(r => r.json());
        const select = document.getElementById('category-filter');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load categories:', error);
      }
    }

    // For event delegation: called with (param, element, event) for global functions
    async function markAsReviewed(variationId, element, event) {
      const button = element;
      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const response = await fetch('/api/expirations/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            variation_ids: [variationId],
            reviewed_by: 'User'
          })
        });

        if (!response.ok) throw new Error('Failed to mark as reviewed');

        // Remove the row from the table since it's been reviewed
        const row = document.querySelector(`tr[data-id="${variationId}"]`);
        if (row) {
          row.style.transition = 'opacity 0.3s';
          row.style.opacity = '0';
          setTimeout(() => {
            row.remove();
            // Update allItems array
            allItems = allItems.filter(item => item.identifier !== variationId);
            updateStats();
            updatePagination();
          }, 300);
        }

      } catch (error) {
        alert('Failed to mark as reviewed: ' + error.message);
        button.disabled = false;
        button.textContent = 'Mark Reviewed';
      }
    }

    async function markAllAsReviewed() {
      const btn = document.getElementById('mark-all-reviewed-btn');
      if (!confirm(`Mark all ${allItems.length} items as reviewed?`)) return;

      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const variationIds = allItems.map(item => item.identifier);

        const response = await fetch('/api/expirations/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            variation_ids: variationIds,
            reviewed_by: 'User'
          })
        });

        if (!response.ok) throw new Error('Failed to mark as reviewed');

        const result = await response.json();
        alert(`Marked ${result.reviewed_count} items as reviewed`);

        // Reload to show empty list
        await loadItems();

      } catch (error) {
        alert('Failed to mark all as reviewed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Mark All as Reviewed';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Check for URL parameters to pre-set filters
      const urlParams = new URLSearchParams(window.location.search);
      const filterParam = urlParams.get('filter');
      if (filterParam) {
        const filterSelect = document.getElementById('expiry-filter');
        // Map friendly names to filter values
        const filterMap = {
          'expiring': '120',
          'expiring-soon': '120',
          'no-data': 'no-expiry',
          'missing': 'no-expiry',
          'review': 'review',
          '30': '30',
          '60': '60',
          '90': '90',
          '120': '120'
        };
        const filterValue = filterMap[filterParam] || filterParam;
        if (filterSelect.querySelector(`option[value="${filterValue}"]`)) {
          filterSelect.value = filterValue;
        }
      }
      loadCategories();
      loadItems();
    });
  </script>
</body>
</html>
