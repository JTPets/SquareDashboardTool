<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendor Dashboard - Square Dashboard Addon</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
      line-height: 1.4;
    }
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #2563eb;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .back-button {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 13px;
      white-space: nowrap;
    }
    .back-button:hover { background: rgba(255,255,255,0.3); }
    @media (max-width: 600px) {
      .header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      .header h1 { font-size: 20px; }
      .header-buttons { justify-content: center; }
      .back-button { flex: 1; text-align: center; min-width: 80px; }
    }

    /* Summary cards */
    .stats-bar {
      background: #1f2937;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    .stat { text-align: center; min-width: 100px; }
    .stat-number { font-size: 24px; font-weight: bold; color: #10b981; }
    .stat-number.alert { color: #ef4444; }
    .stat-label { font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* Filter bar */
    .controls {
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      color: #374151;
    }
    .filter-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    .filter-btn:hover:not(.active) { background: #f3f4f6; }
    .controls select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      min-height: 38px;
      background: white;
      margin-left: auto;
    }
    .controls label { font-size: 13px; font-weight: 500; color: #6b7280; margin-left: auto; }

    /* Table */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    thead { position: sticky; top: 0; z-index: 100; }
    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    tr.vendor-row { cursor: pointer; }
    tr.vendor-row:hover { background: #f9fafb; }

    /* Vendor cell */
    .vendor-name { font-weight: 600; color: #1f2937; }
    .vendor-items { font-size: 12px; color: #6b7280; }

    /* Status badges */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }
    .badge-has_oos { background: #fee2e2; color: #991b1b; }
    .badge-below_min { background: #fef3c7; color: #92400e; }
    .badge-ready { background: #dbeafe; color: #1e40af; }
    .badge-needs_order { background: #f3f4f6; color: #374151; }
    .badge-ok { background: #d1fae5; color: #065f46; }

    /* Pill badges for counts */
    .pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
    }
    .pill-red { background: #fee2e2; color: #991b1b; }
    .pill-yellow { background: #fef3c7; color: #92400e; }
    .pill-grey { background: #f3f4f6; color: #9ca3af; }

    /* Progress bar for PO vs Minimum */
    .po-progress { min-width: 120px; }
    .po-progress-text { font-size: 12px; color: #374151; margin-bottom: 3px; white-space: nowrap; }
    .po-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }
    .po-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .po-progress-fill.met { background: #10b981; }
    .po-progress-fill.unmet { background: #f59e0b; }

    /* Last ordered coloring */
    .last-ordered-red { color: #ef4444; font-weight: 600; }
    .last-ordered-yellow { color: #f59e0b; font-weight: 600; }

    /* Payment method badges */
    .payment-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .payment-credit-card { background: #d1fae5; color: #065f46; }
    .payment-invoice { background: #dbeafe; color: #1e40af; }
    .payment-e-transfer { background: #ede9fe; color: #5b21b6; }
    .payment-cod { background: #fef3c7; color: #92400e; }
    .payment-na { background: #f3f4f6; color: #6b7280; }

    /* Expanded row */
    .expanded-row { display: none; }
    .expanded-row.visible { display: table-row; }
    .expanded-content {
      padding: 20px;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 16px;
    }
    @media (max-width: 768px) {
      .detail-grid { grid-template-columns: 1fr; }
    }
    .detail-section h4 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }
    .detail-label { color: #6b7280; }
    .detail-value { color: #1f2937; font-weight: 500; }
    .detail-notes {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      background: white;
    }
    .detail-notes[readonly] {
      background: #f9fafb;
      border-color: #e5e7eb;
      resize: none;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      line-height: 1.4;
    }
    .btn-primary { background: #1f2937; color: white; }
    .btn-primary:hover { background: #111827; }
    .btn-blue { background: #2563eb; color: white; }
    .btn-blue:hover { background: #1d4ed8; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-outline { background: white; color: #374151; border: 1px solid #d1d5db; }
    .btn-outline:hover { background: #f3f4f6; }
    .btn-green { background: #059669; color: white; }
    .btn-green:hover { background: #047857; }

    /* Edit mode */
    .edit-form { display: none; }
    .edit-form.visible { display: block; }
    .view-mode.hidden { display: none; }
    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 768px) {
      .edit-grid { grid-template-columns: 1fr; }
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 12px; font-weight: 600; color: #374151; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-group .hint { font-size: 11px; color: #9ca3af; }
    .form-actions {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    /* Loading & empty states */
    .loading { text-align: center; padding: 40px; color: #6b7280; }
    .empty { text-align: center; padding: 40px; color: #9ca3af; }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.visible { opacity: 1; transform: translateY(0); }
    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Vendor Dashboard</h1>
      <div class="header-buttons">
        <a href="reorder.html" class="back-button">Reorder Suggestions</a>
        <a href="purchase-orders.html" class="back-button">Purchase Orders</a>
        <a href="dashboard.html" class="back-button">Back to Dashboard</a>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="stats-bar">
      <div class="stat">
        <div class="stat-number" id="stat-oos">--</div>
        <div class="stat-label">Out of Stock</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-reorder">--</div>
        <div class="stat-label">Items to Reorder</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-po-value">--</div>
        <div class="stat-label">Pending PO Value</div>
      </div>
      <div class="stat">
        <div class="stat-number" id="stat-action">--</div>
        <div class="stat-label">Vendors Need Action</div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="controls">
      <button class="filter-btn active" id="filter-all" onclick="setFilter('all')">All (0)</button>
      <button class="filter-btn" id="filter-action" onclick="setFilter('action')">Needs Action (0)</button>
      <label for="sort-select">Sort:</label>
      <select id="sort-select" onchange="sortVendors()">
        <option value="status">Status</option>
        <option value="name">Name</option>
        <option value="last_ordered">Last Ordered</option>
      </select>
    </div>

    <!-- Vendor Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Status</th>
            <th>Schedule</th>
            <th>OOS</th>
            <th>Reorder</th>
            <th>PO vs Minimum</th>
            <th>Last Ordered</th>
            <th>Payment</th>
          </tr>
        </thead>
        <tbody id="vendor-tbody">
          <tr><td colspan="8" class="loading">Loading vendor data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let allVendors = [];
    let currentFilter = 'all';

    const STATUS_LABELS = {
      has_oos: 'HAS OOS',
      below_min: 'BELOW MIN',
      ready: 'READY',
      needs_order: 'NEEDS ORDER',
      ok: 'OK'
    };

    const STATUS_ORDER = { has_oos: 0, below_min: 1, ready: 2, needs_order: 3, ok: 4 };

    const DAY_ABBREV = {
      Monday: 'Mon', Tuesday: 'Tue', Wednesday: 'Wed', Thursday: 'Thu',
      Friday: 'Fri', Saturday: 'Sat', Sunday: 'Sun'
    };

    // ==================== DATA LOADING ====================

    async function loadVendors() {
      try {
        const res = await fetch('/api/vendor-dashboard');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        allVendors = data.vendors || [];
        updateSummary();
        renderTable();
      } catch (err) {
        document.getElementById('vendor-tbody').innerHTML =
          `<tr><td colspan="8" class="empty">Failed to load vendor data: ${escapeHtml(err.message)}</td></tr>`;
      }
    }

    // ==================== SUMMARY CARDS ====================

    function updateSummary() {
      const totalOos = allVendors.reduce((s, v) => s + v.oos_count, 0);
      const totalReorder = allVendors.reduce((s, v) => s + v.reorder_count, 0);
      const totalPoValue = allVendors.reduce((s, v) => s + v.pending_po_value, 0);
      const actionCount = allVendors.filter(v => v.status !== 'ok').length;

      const oosEl = document.getElementById('stat-oos');
      oosEl.textContent = totalOos;
      oosEl.className = totalOos > 0 ? 'stat-number alert' : 'stat-number';

      document.getElementById('stat-reorder').textContent = totalReorder;
      document.getElementById('stat-po-value').textContent = formatCurrency(totalPoValue);

      const actionEl = document.getElementById('stat-action');
      actionEl.textContent = actionCount;
      actionEl.className = actionCount > 0 ? 'stat-number alert' : 'stat-number';

      document.getElementById('filter-all').textContent = `All (${allVendors.length})`;
      document.getElementById('filter-action').textContent = `Needs Action (${actionCount})`;
    }

    // ==================== FILTERING & SORTING ====================

    function setFilter(filter) {
      currentFilter = filter;
      document.getElementById('filter-all').classList.toggle('active', filter === 'all');
      document.getElementById('filter-action').classList.toggle('active', filter === 'action');
      renderTable();
    }

    function sortVendors() {
      renderTable();
    }

    function getFilteredSorted() {
      let vendors = [...allVendors];

      if (currentFilter === 'action') {
        vendors = vendors.filter(v => v.status !== 'ok');
      }

      const sortBy = document.getElementById('sort-select').value;
      vendors.sort((a, b) => {
        if (sortBy === 'status') {
          const diff = STATUS_ORDER[a.status] - STATUS_ORDER[b.status];
          return diff !== 0 ? diff : a.name.localeCompare(b.name);
        }
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        if (sortBy === 'last_ordered') {
          const dateA = a.last_ordered_at ? new Date(a.last_ordered_at) : new Date(0);
          const dateB = b.last_ordered_at ? new Date(b.last_ordered_at) : new Date(0);
          return dateA - dateB; // oldest first (most urgent)
        }
        return 0;
      });

      return vendors;
    }

    // ==================== TABLE RENDERING ====================

    function renderTable() {
      const tbody = document.getElementById('vendor-tbody');
      const vendors = getFilteredSorted();

      if (vendors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">No vendors match the current filter.</td></tr>';
        return;
      }

      tbody.innerHTML = vendors.map(v => renderVendorRow(v) + renderExpandedRow(v)).join('');
    }

    function renderVendorRow(v) {
      return `
        <tr class="vendor-row" onclick="toggleExpand('${v.id}')">
          <td>
            <div class="vendor-name">${escapeHtml(v.name)}</div>
            <div class="vendor-items">${v.total_items} items</div>
          </td>
          <td><span class="badge badge-${v.status}">${STATUS_LABELS[v.status]}</span></td>
          <td>${renderSchedule(v)}</td>
          <td>${v.oos_count > 0 ? `<span class="pill pill-red">${v.oos_count}</span>` : '<span class="pill pill-grey">0</span>'}</td>
          <td>${renderReorderPill(v.reorder_count)}</td>
          <td>${renderPoProgress(v)}</td>
          <td>${renderLastOrdered(v.last_ordered_at)}</td>
          <td>${renderPaymentBadge(v.payment_method)}</td>
        </tr>`;
    }

    function renderSchedule(v) {
      if (v.schedule_type === 'fixed' && v.order_day && v.receive_day) {
        return `${DAY_ABBREV[v.order_day] || v.order_day} &rarr; ${DAY_ABBREV[v.receive_day] || v.receive_day}`;
      }
      if (v.lead_time_days != null) {
        return `~${v.lead_time_days}d lead`;
      }
      return '<span style="color:#9ca3af">--</span>';
    }

    function renderReorderPill(count) {
      if (count === 0) return '<span class="pill pill-grey">0</span>';
      return count > 5
        ? `<span class="pill pill-yellow">${count}</span>`
        : `<span class="pill pill-grey">${count}</span>`;
    }

    function renderPoProgress(v) {
      const min = v.minimum_order_amount;
      const pending = v.pending_po_value;

      if (!min || min === 0) {
        return '<span style="color:#9ca3af">No min</span>';
      }
      if (pending === 0) {
        return `<span style="color:#6b7280">${formatCurrency(min)}</span>`;
      }

      const pct = Math.min(100, Math.round((pending / min) * 100));
      const met = pending >= min;
      return `
        <div class="po-progress">
          <div class="po-progress-text">${formatCurrency(pending)} / ${formatCurrency(min)}</div>
          <div class="po-progress-bar"><div class="po-progress-fill ${met ? 'met' : 'unmet'}" style="width:${pct}%"></div></div>
        </div>`;
    }

    function renderLastOrdered(dateStr) {
      if (!dateStr) return '<span style="color:#9ca3af">Never</span>';
      const days = Math.floor((Date.now() - new Date(dateStr).getTime()) / 86400000);
      let cls = '';
      if (days > 60) cls = 'last-ordered-red';
      else if (days > 30) cls = 'last-ordered-yellow';
      return `<span class="${cls}">${days}d ago</span>`;
    }

    function renderPaymentBadge(method) {
      if (!method) return '<span style="color:#9ca3af">--</span>';
      const cls = {
        'Credit Card': 'payment-credit-card',
        'Invoice': 'payment-invoice',
        'E-Transfer': 'payment-e-transfer',
        'COD': 'payment-cod',
        'N/A': 'payment-na'
      }[method] || 'payment-na';
      return `<span class="payment-badge ${cls}">${escapeHtml(method)}</span>`;
    }

    // ==================== EXPANDED ROW ====================

    function renderExpandedRow(v) {
      return `
        <tr class="expanded-row" id="expand-${v.id}">
          <td colspan="8">
            <div class="expanded-content">
              <!-- View Mode -->
              <div class="view-mode" id="view-${v.id}">
                <div class="detail-grid">
                  <div class="detail-section">
                    <h4>Contact &amp; Ordering</h4>
                    <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${escapeHtml(v.contact_email || 'N/A')}</span></div>
                    <div class="detail-row"><span class="detail-label">Order Method</span><span class="detail-value">${escapeHtml(v.order_method || 'N/A')}</span></div>
                    <div class="detail-row"><span class="detail-label">Payment</span><span class="detail-value">${escapeHtml(v.payment_method || 'N/A')}</span></div>
                    <div class="detail-row"><span class="detail-label">Terms</span><span class="detail-value">${escapeHtml(v.payment_terms || 'N/A')}</span></div>
                  </div>
                  <div class="detail-section">
                    <h4>Schedule &amp; Settings</h4>
                    <div class="detail-row"><span class="detail-label">Schedule</span><span class="detail-value">${v.schedule_type === 'fixed' ? 'Fixed Day' : 'Anytime'}</span></div>
                    ${v.schedule_type === 'fixed' ? `
                      <div class="detail-row"><span class="detail-label">Order Day</span><span class="detail-value">${escapeHtml(v.order_day || 'N/A')}</span></div>
                      <div class="detail-row"><span class="detail-label">Receive Day</span><span class="detail-value">${escapeHtml(v.receive_day || 'N/A')}</span></div>
                    ` : `
                      <div class="detail-row"><span class="detail-label">Lead Time</span><span class="detail-value">${v.lead_time_days != null ? v.lead_time_days + ' days' : 'N/A'}</span></div>
                    `}
                    <div class="detail-row"><span class="detail-label">Minimum Order</span><span class="detail-value">${v.minimum_order_amount ? formatCurrency(v.minimum_order_amount) : 'None'}</span></div>
                    <div class="detail-row"><span class="detail-label">Supply Days</span><span class="detail-value">${v.default_supply_days || 'Default'}</span></div>
                  </div>
                  <div class="detail-section">
                    <h4>Notes</h4>
                    <textarea class="detail-notes" readonly>${escapeHtml(v.notes || '')}</textarea>
                  </div>
                </div>
                <div class="action-buttons">
                  <a href="reorder.html?vendor_id=${encodeURIComponent(v.id)}" class="btn btn-primary">View Reorder Suggestions</a>
                  <a href="purchase-orders.html?vendor_id=${encodeURIComponent(v.id)}" class="btn btn-blue">Create Purchase Order</a>
                  <button class="btn btn-outline" onclick="enterEditMode('${v.id}', event)">Edit Vendor Settings</button>
                  <a href="purchase-orders.html?vendor_id=${encodeURIComponent(v.id)}&view=history" class="btn btn-secondary">Order History</a>
                </div>
              </div>

              <!-- Edit Mode -->
              <div class="edit-form" id="edit-${v.id}">
                <div class="edit-grid">
                  <div class="form-group">
                    <label>Schedule Type</label>
                    <select id="field-schedule_type-${v.id}" onchange="toggleScheduleFields('${v.id}')">
                      <option value="anytime" ${v.schedule_type !== 'fixed' ? 'selected' : ''}>Anytime</option>
                      <option value="fixed" ${v.schedule_type === 'fixed' ? 'selected' : ''}>Fixed Day</option>
                    </select>
                  </div>
                  <div class="form-group" id="fg-order_day-${v.id}" style="${v.schedule_type !== 'fixed' ? 'display:none' : ''}">
                    <label>Order Day</label>
                    <select id="field-order_day-${v.id}">
                      ${renderDayOptions(v.order_day)}
                    </select>
                  </div>
                  <div class="form-group" id="fg-receive_day-${v.id}" style="${v.schedule_type !== 'fixed' ? 'display:none' : ''}">
                    <label>Receive Day</label>
                    <select id="field-receive_day-${v.id}">
                      ${renderDayOptions(v.receive_day)}
                    </select>
                  </div>
                  <div class="form-group" id="fg-lead_time-${v.id}" style="${v.schedule_type === 'fixed' ? 'display:none' : ''}">
                    <label>Lead Time (days)</label>
                    <input type="number" id="field-lead_time_days-${v.id}" min="0" value="${v.lead_time_days != null ? v.lead_time_days : ''}">
                  </div>
                  <div class="form-group">
                    <label>Minimum Order</label>
                    <input type="number" id="field-minimum_order_amount-${v.id}" min="0" step="1" value="${v.minimum_order_amount || ''}">
                    <span class="hint">In cents (e.g. 50000 = $500.00)</span>
                  </div>
                  <div class="form-group">
                    <label>Payment Method</label>
                    <select id="field-payment_method-${v.id}">
                      <option value="">-- Select --</option>
                      ${['Credit Card', 'Invoice', 'E-Transfer', 'COD', 'N/A'].map(m =>
                        `<option value="${m}" ${v.payment_method === m ? 'selected' : ''}>${m}</option>`
                      ).join('')}
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Payment Terms</label>
                    <input type="text" id="field-payment_terms-${v.id}" value="${escapeHtml(v.payment_terms || '')}" placeholder="e.g. Net 14">
                  </div>
                  <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="field-contact_email-${v.id}" value="${escapeHtml(v.contact_email || '')}">
                  </div>
                  <div class="form-group">
                    <label>Order Method</label>
                    <input type="text" id="field-order_method-${v.id}" value="${escapeHtml(v.order_method || '')}" placeholder="e.g. Portal, Email CSV">
                  </div>
                  <div class="form-group">
                    <label>Default Supply Days</label>
                    <input type="number" id="field-default_supply_days-${v.id}" min="1" value="${v.default_supply_days || ''}">
                  </div>
                  <div class="form-group" style="grid-column: 1 / -1">
                    <label>Notes</label>
                    <textarea id="field-notes-${v.id}">${escapeHtml(v.notes || '')}</textarea>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-green" onclick="saveVendorSettings('${v.id}', event)">Save</button>
                  <button class="btn btn-outline" onclick="cancelEdit('${v.id}', event)">Cancel</button>
                </div>
              </div>
            </div>
          </td>
        </tr>`;
    }

    function renderDayOptions(selected) {
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      return '<option value="">-- Select --</option>' +
        days.map(d => `<option value="${d}" ${selected === d ? 'selected' : ''}>${d}</option>`).join('');
    }

    // ==================== EXPAND / COLLAPSE ====================

    function toggleExpand(id) {
      const row = document.getElementById(`expand-${id}`);
      if (!row) return;
      const wasVisible = row.classList.contains('visible');

      // Collapse all
      document.querySelectorAll('.expanded-row.visible').forEach(r => r.classList.remove('visible'));
      // Reset all edit modes
      document.querySelectorAll('.edit-form.visible').forEach(f => {
        f.classList.remove('visible');
        const viewId = f.id.replace('edit-', 'view-');
        const viewEl = document.getElementById(viewId);
        if (viewEl) viewEl.classList.remove('hidden');
      });

      if (!wasVisible) row.classList.add('visible');
    }

    // ==================== EDIT MODE ====================

    function enterEditMode(id, event) {
      event.stopPropagation();
      document.getElementById(`view-${id}`).classList.add('hidden');
      document.getElementById(`edit-${id}`).classList.add('visible');
    }

    function cancelEdit(id, event) {
      event.stopPropagation();
      document.getElementById(`edit-${id}`).classList.remove('visible');
      document.getElementById(`view-${id}`).classList.remove('hidden');
    }

    function toggleScheduleFields(id) {
      const type = document.getElementById(`field-schedule_type-${id}`).value;
      const isFixed = type === 'fixed';
      document.getElementById(`fg-order_day-${id}`).style.display = isFixed ? '' : 'none';
      document.getElementById(`fg-receive_day-${id}`).style.display = isFixed ? '' : 'none';
      document.getElementById(`fg-lead_time-${id}`).style.display = isFixed ? 'none' : '';
    }

    async function saveVendorSettings(id, event) {
      event.stopPropagation();

      const getVal = (field) => {
        const el = document.getElementById(`field-${field}-${id}`);
        return el ? el.value : '';
      };

      const scheduleType = getVal('schedule_type');
      const body = {
        schedule_type: scheduleType,
        order_day: scheduleType === 'fixed' ? (getVal('order_day') || null) : null,
        receive_day: scheduleType === 'fixed' ? (getVal('receive_day') || null) : null,
        lead_time_days: getVal('lead_time_days') !== '' ? parseInt(getVal('lead_time_days')) : null,
        minimum_order_amount: getVal('minimum_order_amount') !== '' ? parseInt(getVal('minimum_order_amount')) : 0,
        payment_method: getVal('payment_method') || null,
        payment_terms: getVal('payment_terms') || null,
        contact_email: getVal('contact_email') || null,
        order_method: getVal('order_method') || null,
        default_supply_days: getVal('default_supply_days') !== '' ? parseInt(getVal('default_supply_days')) : null,
        notes: getVal('notes') || null
      };

      try {
        const res = await fetch(`/api/vendors/${encodeURIComponent(id)}/settings`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!res.ok) {
          const msg = data.details
            ? data.details.map(d => d.message).join(', ')
            : (data.error || 'Save failed');
          showToast(msg, 'error');
          return;
        }

        showToast('Vendor settings saved', 'success');
        // Reload to get fresh stats
        await loadVendors();
      } catch (err) {
        showToast('Network error: ' + err.message, 'error');
      }
    }

    // ==================== HELPERS ====================

    function formatCurrency(cents) {
      if (cents == null) return '$0.00';
      return '$' + (cents / 100).toLocaleString('en-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      setTimeout(() => { toast.classList.remove('visible'); }, 3000);
    }

    // ==================== INIT ====================
    loadVendors();
  </script>
</body>
</html>
