<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscribe - Square Dashboard Addon Tool</title>
  <!-- Square Web Payments SDK loaded dynamically based on environment -->
  <style>
    /* BASE STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    /* CONTAINER */
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      text-align: center;
      color: white;
      padding: 40px 20px;
    }

    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 18px;
      opacity: 0.9;
    }

    /* INTRO BADGE */
    .intro-badge {
      display: inline-block;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* PRICING CARDS */
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .pricing-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
      transition: transform 0.3s ease;
    }

    .pricing-card:hover {
      transform: translateY(-5px);
    }

    .pricing-card.popular {
      border: 3px solid #10b981;
    }

    .popular-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: white;
      padding: 5px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .pricing-card h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .price {
      font-size: 48px;
      font-weight: 700;
      color: #2563eb;
      margin: 20px 0;
    }

    .price span {
      font-size: 18px;
      color: #6b7280;
      font-weight: 400;
    }

    .price-note {
      font-size: 14px;
      color: #10b981;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .features {
      text-align: left;
      margin: 25px 0;
    }

    .features li {
      list-style: none;
      padding: 8px 0;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .features li::before {
      content: "✓";
      color: #10b981;
      font-weight: bold;
      font-size: 18px;
    }

    .select-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .select-btn.primary {
      background: #2563eb;
      color: white;
    }

    .select-btn.primary:hover {
      background: #1d4ed8;
    }

    .select-btn.secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .select-btn.secondary:hover {
      background: #e5e7eb;
    }

    .select-btn.selected {
      background: #10b981;
      color: white;
    }

    /* CHECKOUT SECTION */
    .checkout-section {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: none;
    }

    .checkout-section.active {
      display: block;
    }

    .checkout-section h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 30px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* Square Card Container */
    #card-container {
      min-height: 90px;
      margin-bottom: 20px;
    }

    /* Promo Code Section */
    .promo-section {
      margin: 20px 0;
    }

    .apply-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .apply-btn:hover {
      background: #2563eb;
    }

    .apply-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .promo-message {
      margin-top: 8px;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .promo-message.success {
      background: #ecfdf5;
      color: #059669;
      border: 1px solid #10b981;
    }

    .promo-message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #f87171;
    }

    .order-summary {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
    }

    .order-summary h3 {
      font-size: 16px;
      color: #374151;
      margin-bottom: 15px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      color: #4b5563;
    }

    .summary-row.total {
      border-top: 2px solid #e5e7eb;
      margin-top: 10px;
      padding-top: 15px;
      font-weight: 700;
      color: #1f2937;
      font-size: 18px;
    }

    .trial-notice {
      background: #ecfdf5;
      border: 1px solid #10b981;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }

    .trial-notice p {
      color: #065f46;
      font-size: 14px;
    }

    .trial-notice strong {
      color: #047857;
    }

    .subscribe-btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .subscribe-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4);
    }

    .subscribe-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .secure-notice {
      text-align: center;
      margin-top: 20px;
      color: #6b7280;
      font-size: 13px;
    }

    .secure-notice svg {
      vertical-align: middle;
      margin-right: 5px;
    }

    /* MESSAGES */
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .message.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
      display: block;
    }

    .message.success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
      display: block;
    }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 30px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }

    .footer a {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* LOADING SPINNER */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* BACK LINK */
    .back-link {
      display: inline-block;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .back-link:hover {
      color: white;
    }

    /* TERMS CHECKBOX */
    .terms-acceptance {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      cursor: pointer;
    }

    .checkbox-label a {
      color: #2563eb;
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* TERMS MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
      position: relative;
    }

    .modal-content h2 {
      color: #1f2937;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .modal-content h3 {
      color: #374151;
      margin: 20px 0 10px;
      font-size: 16px;
    }

    .modal-content p {
      color: #4b5563;
      line-height: 1.7;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .modal-content ul {
      margin: 10px 0 15px 20px;
      color: #4b5563;
      font-size: 14px;
    }

    .modal-content li {
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      line-height: 1;
    }

    .modal-close:hover {
      color: #1f2937;
    }

    .modal-accept-btn {
      width: 100%;
      padding: 15px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
    }

    .modal-accept-btn:hover {
      background: #1d4ed8;
    }

    .disclaimer-box {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .disclaimer-box p {
      color: #92400e;
      margin: 0;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header h1 {
        font-size: 28px;
      }

      .pricing-grid {
        grid-template-columns: 1fr;
      }

      .checkout-section {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; Back to Home</a>

    <!-- HEADER -->
    <div class="header">
      <div class="intro-badge">Limited Time Introductory Pricing</div>
      <h1>Square Dashboard Addon Tool</h1>
      <p>Powerful inventory management, reorder automation, and analytics for Square POS</p>
    </div>

    <!-- PRICING CARDS -->
    <div class="pricing-grid">
      <!-- MONTHLY -->
      <div class="pricing-card" id="card-monthly">
        <h2>Monthly</h2>
        <div class="price">$29.99<span>/month</span></div>
        <div class="price-note">Introductory Price - Lock it in!</div>
        <ul class="features">
          <li>Full feature access</li>
          <li>Unlimited inventory items</li>
          <li>Reorder automation</li>
          <li>Sales velocity analytics</li>
          <li>Purchase order management</li>
          <li>Expiry date tracking</li>
          <li>Loyalty rewards program</li>
          <li>Multi-location support</li>
          <li>Email notifications</li>
        </ul>
        <button class="select-btn secondary" onclick="selectPlan('monthly')">Select Monthly</button>
      </div>

      <!-- ANNUAL -->
      <div class="pricing-card popular" id="card-annual">
        <div class="popular-badge">Best Value</div>
        <h2>Annual</h2>
        <div class="price">$299.99<span>/year</span></div>
        <div class="price-note">Save $60 - Only $25/month!</div>
        <ul class="features">
          <li>Everything in Monthly</li>
          <li>2 months FREE</li>
          <li>Price locked for 12 months</li>
          <li>Priority support</li>
          <li>Early access to new features</li>
          <li>Dedicated onboarding</li>
          <li>Data export tools</li>
          <li>API access</li>
        </ul>
        <button class="select-btn primary" onclick="selectPlan('annual')">Select Annual</button>
      </div>
    </div>

    <!-- CHECKOUT SECTION -->
    <div class="checkout-section" id="checkout-section">
      <h2>Complete Your Subscription</h2>

      <div id="message" class="message"></div>

      <form id="payment-form" onsubmit="handleSubscribe(event)">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" placeholder="your@email.com" required>
        </div>

        <div class="form-group">
          <label for="business">Business Name (Optional)</label>
          <input type="text" id="business" name="business" placeholder="Your Business Name">
        </div>

        <div class="form-group">
          <label>Payment Information</label>
          <div id="card-container"></div>
        </div>

        <div class="trial-notice">
          <p><strong>30-Day Free Trial</strong></p>
          <p>Your card will be charged today but you have 30 days to try the full platform.</p>
          <p><strong>100% refundable</strong> if you cancel within 30 days - no questions asked!</p>
        </div>

        <div class="terms-acceptance">
          <label class="checkbox-label">
            <input type="checkbox" id="terms-accepted" required>
            <span>I agree to the <a href="#" onclick="openTermsModal(); return false;">Terms of Service</a> and acknowledge the <a href="#" onclick="openTermsModal(); return false;">Liability Disclaimer</a></span>
          </label>
        </div>

        <div class="form-group promo-section">
          <label for="promo-code">Promo Code (Optional)</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="promo-code" name="promoCode" placeholder="Enter code" style="flex: 1;">
            <button type="button" class="apply-btn" onclick="applyPromoCode()">Apply</button>
          </div>
          <div id="promo-message" class="promo-message"></div>
        </div>

        <div class="order-summary">
          <h3>Order Summary</h3>
          <div class="summary-row">
            <span id="plan-name">Monthly Plan (Intro)</span>
            <span id="plan-price">$9.99</span>
          </div>
          <div class="summary-row" id="discount-row" style="display: none; color: #10b981;">
            <span id="discount-label">Discount</span>
            <span id="discount-amount">-$0.00</span>
          </div>
          <div class="summary-row">
            <span>30-Day Trial</span>
            <span style="color: #10b981;">Included</span>
          </div>
          <div class="summary-row total">
            <span>Total Today</span>
            <span id="total-price">$9.99 CAD</span>
          </div>
        </div>

        <button type="submit" class="subscribe-btn" id="subscribe-btn">
          <span id="btn-text">Start Free Trial</span>
          <div class="spinner" id="spinner" style="display: none;"></div>
        </button>

        <div class="secure-notice">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          Secured by Square. Your payment info is encrypted.
        </div>
      </form>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <p>&copy; <span id="year"></span> Square Dashboard Addon Tool</p>
      <p>
        <a href="/support.html">Support</a> |
        <a href="/dashboard.html">Dashboard</a>
      </p>
    </div>
  </div>

  <!-- TERMS OF SERVICE MODAL -->
  <div class="modal-overlay" id="terms-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeTermsModal()">&times;</button>

      <h2>Terms of Service & Liability Disclaimer</h2>

      <p><strong>Effective Date:</strong> January 2026</p>

      <h3>1. Acceptance of Terms</h3>
      <p>By subscribing to and using the Square Dashboard Addon Tool ("Service"), you agree to be bound by these Terms of Service. If you do not agree, please do not use this Service.</p>

      <h3>2. Service Description</h3>
      <p>The Service provides inventory management, sales analytics, and purchase order tools that integrate with your Square POS account. The Service requires OAuth authorization to access your Square account data.</p>

      <h3>3. Data Security</h3>
      <p>We implement industry-standard security measures including:</p>
      <ul>
        <li>AES-256-GCM encryption for stored OAuth tokens</li>
        <li>Session-based authentication with secure cookies</li>
        <li>Multi-tenant data isolation</li>
        <li>HTTPS encryption for all data transmission</li>
        <li>Role-based access controls</li>
      </ul>

      <div class="disclaimer-box">
        <p><strong>IMPORTANT SECURITY DISCLAIMER:</strong> While this software is designed and built with security as a priority, no computer system can be guaranteed to be completely secure. By nature, all computer systems carry inherent security risks. We employ best practices and reasonable measures to protect your data and prevent unauthorized access; however, we cannot guarantee absolute security against all potential threats, vulnerabilities, or breaches.</p>
      </div>

      <h3>4. Limitation of Liability</h3>
      <p>TO THE MAXIMUM EXTENT PERMITTED BY LAW:</p>
      <ul>
        <li>The Service is provided "AS IS" and "AS AVAILABLE" without warranties of any kind, express or implied.</li>
        <li>We are not liable for any unauthorized access to, or alteration, theft, or destruction of your data through accident, fraudulent means, or any unauthorized access.</li>
        <li>We are not liable for any indirect, incidental, special, consequential, or punitive damages, including but not limited to loss of profits, data, business opportunities, or goodwill.</li>
        <li>Our total liability for any claims arising from your use of the Service shall not exceed the amount you paid for the Service in the 12 months preceding the claim.</li>
        <li>We are not responsible for any actions taken by Square, Inc. regarding your Square account or API access.</li>
      </ul>

      <h3>5. Your Responsibilities</h3>
      <p>You are responsible for:</p>
      <ul>
        <li>Maintaining the confidentiality of your account credentials</li>
        <li>All activities that occur under your account</li>
        <li>Ensuring your use complies with Square's Terms of Service</li>
        <li>Backing up your own data as needed</li>
        <li>Promptly notifying us of any unauthorized access</li>
      </ul>

      <h3>6. Data Processing</h3>
      <p>By using the Service, you authorize us to access, retrieve, and process data from your Square account as necessary to provide the Service. This includes inventory, sales, catalog, and location data.</p>

      <h3>7. Subscription & Cancellation</h3>
      <ul>
        <li>Subscriptions auto-renew unless cancelled</li>
        <li>You may cancel at any time through your account settings</li>
        <li>Refunds are available within 30 days of initial purchase</li>
        <li>Upon cancellation, your access will continue until the end of your billing period</li>
      </ul>

      <h3>8. Modifications</h3>
      <p>We reserve the right to modify these terms at any time. Continued use of the Service after changes constitutes acceptance of the new terms.</p>

      <h3>9. Governing Law</h3>
      <p>These terms are governed by the laws of the jurisdiction in which the Service provider operates, without regard to conflict of law principles.</p>

      <h3>10. Contact</h3>
      <p>For questions about these terms, please contact us through the Support page.</p>

      <button class="modal-accept-btn" onclick="acceptTerms()">I Understand and Accept</button>
    </div>
  </div>

  <!-- Error Helper for user-friendly messages -->
  <script src="/js/error-helper.js"></script>

  <script data-cfasync="false">
    // Set year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Terms modal functions
    function openTermsModal() {
      document.getElementById('terms-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeTermsModal() {
      document.getElementById('terms-modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function acceptTerms() {
      document.getElementById('terms-accepted').checked = true;
      closeTermsModal();
    }

    // Close modal on overlay click
    document.getElementById('terms-modal').addEventListener('click', function(e) {
      if (e.target === this) closeTermsModal();
    });

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeTermsModal();
    });

    // State
    let selectedPlan = null;
    let card = null;
    let payments = null;

    // Plan data
    const plans = {
      monthly: {
        name: 'Monthly Plan (Intro)',
        price: 999,
        displayPrice: '$9.99',
        period: '/month'
      },
      annual: {
        name: 'Annual Plan (Intro)',
        price: 9999,
        displayPrice: '$99.99',
        period: '/year'
      }
    };

    // Promo code state
    let appliedPromo = null;

    // Apply promo code
    async function applyPromoCode() {
      const codeInput = document.getElementById('promo-code');
      const messageEl = document.getElementById('promo-message');
      const code = codeInput.value.trim();

      if (!code) {
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Please enter a promo code';
        messageEl.style.display = 'block';
        return;
      }

      if (!selectedPlan) {
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Please select a plan first';
        messageEl.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/api/subscriptions/promo/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code,
            plan: selectedPlan,
            priceCents: plans[selectedPlan].price
          })
        });

        const result = await response.json();

        if (result.valid) {
          appliedPromo = result;
          messageEl.className = 'promo-message success';
          messageEl.textContent = `✓ ${result.discountDisplay} applied!`;
          messageEl.style.display = 'block';
          codeInput.disabled = true;

          // Update order summary with discount
          updateOrderSummary();
        } else {
          appliedPromo = null;
          messageEl.className = 'promo-message error';
          messageEl.textContent = result.error || 'Invalid promo code';
          messageEl.style.display = 'block';
          updateOrderSummary();
        }
      } catch (error) {
        console.error('Promo validation error:', error);
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Failed to validate code. Please try again.';
        messageEl.style.display = 'block';
      }
    }

    // Update order summary with discount
    function updateOrderSummary() {
      if (!selectedPlan) return;

      const plan = plans[selectedPlan];
      const discountRow = document.getElementById('discount-row');
      const discountLabel = document.getElementById('discount-label');
      const discountAmount = document.getElementById('discount-amount');
      const totalPrice = document.getElementById('total-price');

      if (appliedPromo && appliedPromo.discountCents > 0) {
        discountRow.style.display = 'flex';
        discountLabel.textContent = `Discount (${appliedPromo.code})`;
        discountAmount.textContent = `-$${(appliedPromo.discountCents / 100).toFixed(2)}`;

        const finalPrice = (plan.price - appliedPromo.discountCents) / 100;
        totalPrice.textContent = finalPrice > 0 ? `$${finalPrice.toFixed(2)} CAD` : 'FREE';
      } else {
        discountRow.style.display = 'none';
        totalPrice.textContent = plan.displayPrice + ' CAD';
      }
    }

    // Clear promo when changing plans
    function clearPromo() {
      appliedPromo = null;
      const codeInput = document.getElementById('promo-code');
      const messageEl = document.getElementById('promo-message');
      codeInput.value = '';
      codeInput.disabled = false;
      messageEl.style.display = 'none';
      document.getElementById('discount-row').style.display = 'none';
    }

    // Load Square SDK dynamically based on environment
    function loadSquareSDK(environment) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = environment === 'production'
          ? 'https://web.squarecdn.com/v1/square.js'
          : 'https://sandbox.web.squarecdn.com/v1/square.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load Square SDK'));
        document.head.appendChild(script);
      });
    }

    // Initialize Square Payments
    async function initializeSquare() {
      try {
        // Fetch application ID, location ID, and environment from server
        const config = await fetch('/api/square/payment-config').then(r => r.json());

        if (!config.applicationId) {
          console.error('Square application ID not configured');
          return;
        }

        // Load the correct SDK for the environment
        await loadSquareSDK(config.environment);
        console.log(`Loaded Square SDK for ${config.environment} environment`);

        payments = Square.payments(config.applicationId, config.locationId);

        // Create card payment method
        card = await payments.card();
        await card.attach('#card-container');

        console.log('Square Payments initialized');
      } catch (error) {
        console.error('Failed to initialize Square Payments:', error);
        showMessage('error', 'Payment system unavailable. Please try again later.');
      }
    }

    // Select plan
    function selectPlan(planKey) {
      selectedPlan = planKey;
      const plan = plans[planKey];

      // Clear any applied promo when changing plans
      clearPromo();

      // Update button states
      document.querySelectorAll('.select-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.textContent = btn.textContent.replace('Selected', 'Select');
      });

      const selectedCard = document.getElementById(`card-${planKey}`);
      const btn = selectedCard.querySelector('.select-btn');
      btn.classList.add('selected');
      btn.textContent = 'Selected';

      // Update order summary
      document.getElementById('plan-name').textContent = plan.name;
      document.getElementById('plan-price').textContent = plan.displayPrice;
      document.getElementById('total-price').textContent = plan.displayPrice + ' CAD';

      // Show checkout section
      document.getElementById('checkout-section').classList.add('active');

      // Scroll to checkout
      document.getElementById('checkout-section').scrollIntoView({ behavior: 'smooth' });

      // Initialize Square if not already done
      if (!payments) {
        initializeSquare();
      }
    }

    // Show message
    function showMessage(type, text) {
      const msg = document.getElementById('message');
      msg.className = `message ${type}`;
      msg.textContent = text;
      msg.scrollIntoView({ behavior: 'smooth' });
    }

    // Handle subscription
    async function handleSubscribe(event) {
      event.preventDefault();

      if (!selectedPlan) {
        showMessage('error', 'Please select a plan first.');
        return;
      }

      if (!card) {
        showMessage('error', 'Payment system not ready. Please refresh and try again.');
        return;
      }

      const email = document.getElementById('email').value.trim();
      const business = document.getElementById('business').value.trim();

      if (!email) {
        showMessage('error', 'Please enter your email address.');
        return;
      }

      // Validate terms acceptance
      const termsAccepted = document.getElementById('terms-accepted').checked;
      if (!termsAccepted) {
        showMessage('error', 'Please accept the Terms of Service to continue.');
        return;
      }

      // Disable button and show loading
      const btn = document.getElementById('subscribe-btn');
      const btnText = document.getElementById('btn-text');
      const spinner = document.getElementById('spinner');

      btn.disabled = true;
      btnText.textContent = 'Processing...';
      spinner.style.display = 'block';

      try {
        // Tokenize the card
        const result = await card.tokenize();

        if (result.status !== 'OK') {
          throw new Error(result.errors?.[0]?.message || 'Card tokenization failed');
        }

        // Submit to server
        const response = await fetch('/api/subscriptions/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            businessName: business,
            plan: selectedPlan,
            sourceId: result.token,
            promoCode: appliedPromo?.code || null,
            termsAcceptedAt: new Date().toISOString()
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Subscription creation failed');
        }

        // Success! Check if we need to set up a password
        if (data.passwordSetupUrl) {
          showMessage('success', 'Account created! Redirecting to set up your password...');
          setTimeout(() => {
            window.location.href = data.passwordSetupUrl + '&new=true';
          }, 2000);
        } else {
          showMessage('success', 'Subscription created successfully! Redirecting to login...');
          setTimeout(() => {
            window.location.href = '/login.html?subscribed=true';
          }, 2000);
        }

      } catch (error) {
        console.error('Subscription error:', error);
        showMessage('error', error.message || 'An error occurred. Please try again.');

        btn.disabled = false;
        btnText.textContent = 'Start Free Trial';
        spinner.style.display = 'none';
      }
    }

    // Pre-select annual plan (best value)
    document.addEventListener('DOMContentLoaded', () => {
      // Don't auto-select, let user choose
    });
  </script>
</body>
</html>
