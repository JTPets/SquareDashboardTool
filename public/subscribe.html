<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscribe - Square Dashboard Addon Tool</title>
  <!-- Square Web Payments SDK loaded dynamically based on environment -->
  <style>
    /* BASE STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    /* CONTAINER */
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      text-align: center;
      color: white;
      padding: 40px 20px;
    }

    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 18px;
      opacity: 0.9;
    }

    /* INTRO BADGE */
    .intro-badge {
      display: inline-block;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* PRICING CARDS */
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .pricing-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
      transition: transform 0.3s ease;
    }

    .pricing-card:hover {
      transform: translateY(-5px);
    }

    .pricing-card.popular {
      border: 3px solid #10b981;
    }

    .popular-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: white;
      padding: 5px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .pricing-card h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .price {
      font-size: 48px;
      font-weight: 700;
      color: #2563eb;
      margin: 20px 0;
    }

    .price span {
      font-size: 18px;
      color: #6b7280;
      font-weight: 400;
    }

    .price-note {
      font-size: 14px;
      color: #10b981;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .features {
      text-align: left;
      margin: 25px 0;
    }

    .features li {
      list-style: none;
      padding: 8px 0;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .features li::before {
      content: "✓";
      color: #10b981;
      font-weight: bold;
      font-size: 18px;
    }

    .select-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .select-btn.primary {
      background: #2563eb;
      color: white;
    }

    .select-btn.primary:hover {
      background: #1d4ed8;
    }

    .select-btn.secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .select-btn.secondary:hover {
      background: #e5e7eb;
    }

    .select-btn.selected {
      background: #10b981;
      color: white;
    }

    /* CHECKOUT SECTION */
    .checkout-section {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: none;
    }

    .checkout-section.active {
      display: block;
    }

    .checkout-section h2 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 30px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
    }

    /* Square Card Container */
    #card-container {
      min-height: 90px;
      margin-bottom: 20px;
    }

    /* Promo Code Section */
    .promo-section {
      margin: 20px 0;
    }

    .apply-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .apply-btn:hover {
      background: #2563eb;
    }

    .apply-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .promo-message {
      margin-top: 8px;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .promo-message.success {
      background: #ecfdf5;
      color: #059669;
      border: 1px solid #10b981;
    }

    .promo-message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #f87171;
    }

    .order-summary {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
    }

    .order-summary h3 {
      font-size: 16px;
      color: #374151;
      margin-bottom: 15px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      color: #4b5563;
    }

    .summary-row.total {
      border-top: 2px solid #e5e7eb;
      margin-top: 10px;
      padding-top: 15px;
      font-weight: 700;
      color: #1f2937;
      font-size: 18px;
    }

    .trial-notice {
      background: #ecfdf5;
      border: 1px solid #10b981;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }

    .trial-notice p {
      color: #065f46;
      font-size: 14px;
    }

    .trial-notice strong {
      color: #047857;
    }

    .subscribe-btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .subscribe-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4);
    }

    .subscribe-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .secure-notice {
      text-align: center;
      margin-top: 20px;
      color: #6b7280;
      font-size: 13px;
    }

    .secure-notice svg {
      vertical-align: middle;
      margin-right: 5px;
    }

    /* MESSAGES */
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .message.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
      display: block;
    }

    .message.success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
      display: block;
    }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 30px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }

    .footer a {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* LOADING SPINNER */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* BACK LINK */
    .back-link {
      display: inline-block;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .back-link:hover {
      color: white;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header h1 {
        font-size: 28px;
      }

      .pricing-grid {
        grid-template-columns: 1fr;
      }

      .checkout-section {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; Back to Home</a>

    <!-- HEADER -->
    <div class="header">
      <div class="intro-badge">Limited Time Introductory Pricing</div>
      <h1>Square Dashboard Addon Tool</h1>
      <p>Powerful inventory management, reorder automation, and analytics for Square POS</p>
    </div>

    <!-- PRICING CARDS -->
    <div class="pricing-grid">
      <!-- MONTHLY -->
      <div class="pricing-card" id="card-monthly">
        <h2>Monthly</h2>
        <div class="price">$9.99<span>/month</span></div>
        <div class="price-note">Introductory Price - Lock it in!</div>
        <ul class="features">
          <li>Full feature access</li>
          <li>Unlimited inventory items</li>
          <li>Reorder automation</li>
          <li>Sales velocity analytics</li>
          <li>Purchase order management</li>
          <li>Multi-location support</li>
          <li>Email notifications</li>
          <li>Priority support</li>
        </ul>
        <button class="select-btn secondary" onclick="selectPlan('monthly')">Select Monthly</button>
      </div>

      <!-- ANNUAL -->
      <div class="pricing-card popular" id="card-annual">
        <div class="popular-badge">Best Value</div>
        <h2>Annual</h2>
        <div class="price">$99.99<span>/year</span></div>
        <div class="price-note">Save $20 - Only $8.33/month!</div>
        <ul class="features">
          <li>Everything in Monthly</li>
          <li>2 months FREE</li>
          <li>Price locked for 12 months</li>
          <li>Extended support hours</li>
          <li>Early access to new features</li>
          <li>Dedicated onboarding</li>
          <li>Data export tools</li>
          <li>API access</li>
        </ul>
        <button class="select-btn primary" onclick="selectPlan('annual')">Select Annual</button>
      </div>
    </div>

    <!-- CHECKOUT SECTION -->
    <div class="checkout-section" id="checkout-section">
      <h2>Complete Your Subscription</h2>

      <div id="message" class="message"></div>

      <form id="payment-form" onsubmit="handleSubscribe(event)">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" placeholder="your@email.com" required>
        </div>

        <div class="form-group">
          <label for="business">Business Name (Optional)</label>
          <input type="text" id="business" name="business" placeholder="Your Business Name">
        </div>

        <div class="form-group">
          <label>Payment Information</label>
          <div id="card-container"></div>
        </div>

        <div class="trial-notice">
          <p><strong>30-Day Free Trial</strong></p>
          <p>Your card will be charged today but you have 30 days to try the full platform.</p>
          <p><strong>100% refundable</strong> if you cancel within 30 days - no questions asked!</p>
        </div>

        <div class="form-group promo-section">
          <label for="promo-code">Promo Code (Optional)</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="promo-code" name="promoCode" placeholder="Enter code" style="flex: 1;">
            <button type="button" class="apply-btn" onclick="applyPromoCode()">Apply</button>
          </div>
          <div id="promo-message" class="promo-message"></div>
        </div>

        <div class="order-summary">
          <h3>Order Summary</h3>
          <div class="summary-row">
            <span id="plan-name">Monthly Plan (Intro)</span>
            <span id="plan-price">$9.99</span>
          </div>
          <div class="summary-row" id="discount-row" style="display: none; color: #10b981;">
            <span id="discount-label">Discount</span>
            <span id="discount-amount">-$0.00</span>
          </div>
          <div class="summary-row">
            <span>30-Day Trial</span>
            <span style="color: #10b981;">Included</span>
          </div>
          <div class="summary-row total">
            <span>Total Today</span>
            <span id="total-price">$9.99 CAD</span>
          </div>
        </div>

        <button type="submit" class="subscribe-btn" id="subscribe-btn">
          <span id="btn-text">Start Free Trial</span>
          <div class="spinner" id="spinner" style="display: none;"></div>
        </button>

        <div class="secure-notice">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          Secured by Square. Your payment info is encrypted.
        </div>
      </form>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <p>&copy; <span id="year"></span> Square Dashboard Addon Tool</p>
      <p>
        <a href="/support.html">Support</a> |
        <a href="/dashboard.html">Dashboard</a>
      </p>
    </div>
  </div>

  <!-- Error Helper for user-friendly messages -->
  <script src="/js/error-helper.js"></script>

  <script>
    // Set year
    document.getElementById('year').textContent = new Date().getFullYear();

    // State
    let selectedPlan = null;
    let card = null;
    let payments = null;

    // Plan data
    const plans = {
      monthly: {
        name: 'Monthly Plan (Intro)',
        price: 999,
        displayPrice: '$9.99',
        period: '/month'
      },
      annual: {
        name: 'Annual Plan (Intro)',
        price: 9999,
        displayPrice: '$99.99',
        period: '/year'
      }
    };

    // Promo code state
    let appliedPromo = null;

    // Apply promo code
    async function applyPromoCode() {
      const codeInput = document.getElementById('promo-code');
      const messageEl = document.getElementById('promo-message');
      const code = codeInput.value.trim();

      if (!code) {
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Please enter a promo code';
        messageEl.style.display = 'block';
        return;
      }

      if (!selectedPlan) {
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Please select a plan first';
        messageEl.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/api/subscriptions/promo/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code,
            plan: selectedPlan,
            priceCents: plans[selectedPlan].price
          })
        });

        const result = await response.json();

        if (result.valid) {
          appliedPromo = result;
          messageEl.className = 'promo-message success';
          messageEl.textContent = `✓ ${result.discountDisplay} applied!`;
          messageEl.style.display = 'block';
          codeInput.disabled = true;

          // Update order summary with discount
          updateOrderSummary();
        } else {
          appliedPromo = null;
          messageEl.className = 'promo-message error';
          messageEl.textContent = result.error || 'Invalid promo code';
          messageEl.style.display = 'block';
          updateOrderSummary();
        }
      } catch (error) {
        console.error('Promo validation error:', error);
        messageEl.className = 'promo-message error';
        messageEl.textContent = 'Failed to validate code. Please try again.';
        messageEl.style.display = 'block';
      }
    }

    // Update order summary with discount
    function updateOrderSummary() {
      if (!selectedPlan) return;

      const plan = plans[selectedPlan];
      const discountRow = document.getElementById('discount-row');
      const discountLabel = document.getElementById('discount-label');
      const discountAmount = document.getElementById('discount-amount');
      const totalPrice = document.getElementById('total-price');

      if (appliedPromo && appliedPromo.discountCents > 0) {
        discountRow.style.display = 'flex';
        discountLabel.textContent = `Discount (${appliedPromo.code})`;
        discountAmount.textContent = `-$${(appliedPromo.discountCents / 100).toFixed(2)}`;

        const finalPrice = (plan.price - appliedPromo.discountCents) / 100;
        totalPrice.textContent = finalPrice > 0 ? `$${finalPrice.toFixed(2)} CAD` : 'FREE';
      } else {
        discountRow.style.display = 'none';
        totalPrice.textContent = plan.displayPrice + ' CAD';
      }
    }

    // Clear promo when changing plans
    function clearPromo() {
      appliedPromo = null;
      const codeInput = document.getElementById('promo-code');
      const messageEl = document.getElementById('promo-message');
      codeInput.value = '';
      codeInput.disabled = false;
      messageEl.style.display = 'none';
      document.getElementById('discount-row').style.display = 'none';
    }

    // Load Square SDK dynamically based on environment
    function loadSquareSDK(environment) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = environment === 'production'
          ? 'https://web.squarecdn.com/v1/square.js'
          : 'https://sandbox.web.squarecdn.com/v1/square.js';
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load Square SDK'));
        document.head.appendChild(script);
      });
    }

    // Initialize Square Payments
    async function initializeSquare() {
      try {
        // Fetch application ID, location ID, and environment from server
        const config = await fetch('/api/square/payment-config').then(r => r.json());

        if (!config.applicationId) {
          console.error('Square application ID not configured');
          return;
        }

        // Load the correct SDK for the environment
        await loadSquareSDK(config.environment);
        console.log(`Loaded Square SDK for ${config.environment} environment`);

        payments = Square.payments(config.applicationId, config.locationId);

        // Create card payment method
        card = await payments.card();
        await card.attach('#card-container');

        console.log('Square Payments initialized');
      } catch (error) {
        console.error('Failed to initialize Square Payments:', error);
        showMessage('error', 'Payment system unavailable. Please try again later.');
      }
    }

    // Select plan
    function selectPlan(planKey) {
      selectedPlan = planKey;
      const plan = plans[planKey];

      // Clear any applied promo when changing plans
      clearPromo();

      // Update button states
      document.querySelectorAll('.select-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.textContent = btn.textContent.replace('Selected', 'Select');
      });

      const selectedCard = document.getElementById(`card-${planKey}`);
      const btn = selectedCard.querySelector('.select-btn');
      btn.classList.add('selected');
      btn.textContent = 'Selected';

      // Update order summary
      document.getElementById('plan-name').textContent = plan.name;
      document.getElementById('plan-price').textContent = plan.displayPrice;
      document.getElementById('total-price').textContent = plan.displayPrice + ' CAD';

      // Show checkout section
      document.getElementById('checkout-section').classList.add('active');

      // Scroll to checkout
      document.getElementById('checkout-section').scrollIntoView({ behavior: 'smooth' });

      // Initialize Square if not already done
      if (!payments) {
        initializeSquare();
      }
    }

    // Show message
    function showMessage(type, text) {
      const msg = document.getElementById('message');
      msg.className = `message ${type}`;
      msg.textContent = text;
      msg.scrollIntoView({ behavior: 'smooth' });
    }

    // Handle subscription
    async function handleSubscribe(event) {
      event.preventDefault();

      if (!selectedPlan) {
        showMessage('error', 'Please select a plan first.');
        return;
      }

      if (!card) {
        showMessage('error', 'Payment system not ready. Please refresh and try again.');
        return;
      }

      const email = document.getElementById('email').value.trim();
      const business = document.getElementById('business').value.trim();

      if (!email) {
        showMessage('error', 'Please enter your email address.');
        return;
      }

      // Disable button and show loading
      const btn = document.getElementById('subscribe-btn');
      const btnText = document.getElementById('btn-text');
      const spinner = document.getElementById('spinner');

      btn.disabled = true;
      btnText.textContent = 'Processing...';
      spinner.style.display = 'block';

      try {
        // Tokenize the card
        const result = await card.tokenize();

        if (result.status !== 'OK') {
          throw new Error(result.errors?.[0]?.message || 'Card tokenization failed');
        }

        // Submit to server
        const response = await fetch('/api/subscriptions/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            businessName: business,
            plan: selectedPlan,
            sourceId: result.token,
            promoCode: appliedPromo?.code || null
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Subscription creation failed');
        }

        // Success!
        showMessage('success', 'Subscription created successfully! Redirecting to dashboard...');

        // Redirect after delay
        setTimeout(() => {
          window.location.href = '/?subscribed=true';
        }, 2000);

      } catch (error) {
        console.error('Subscription error:', error);
        showMessage('error', error.message || 'An error occurred. Please try again.');

        btn.disabled = false;
        btnText.textContent = 'Start Free Trial';
        spinner.style.display = 'none';
      }
    }

    // Pre-select annual plan (best value)
    document.addEventListener('DOMContentLoaded', () => {
      // Don't auto-select, let user choose
    });
  </script>
</body>
</html>
